<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link rel="stylesheet" href="./index.css">
  <link rel="stylesheet" href="./app.css">
  <script src="./vue.global.js"></script>
  <script src="./index.full.js"></script>
  <script src="../components.js"></script>
  <script src="./index.js"></script>
</head>
<body>
  <div id="app">
    <el-tabs v-model="activeName" class="demo-tabs">
      <el-tab-pane label="copy routes" name="first">
        <el-form :model="form" label-width="auto" style="max-width: 600px">
          <el-form-item label="Route ids">
            <el-input v-model="form.ids" type="textarea" />
          </el-form-item>
          <el-form-item label="to partner">
            <el-select v-model="form.partnerId" placeholder="please select partner">
              <el-option v-for="(item,index) in partnerIds" :label="item.id" :value="item.id" />
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="copyRoute">copy routes to other partner</el-button>
            <!-- <el-button>Cancel</el-button> -->
          </el-form-item>
        </el-form>
      </el-tab-pane>
      <el-tab-pane label="addTz" name="second">
        <el-button class="btn" type="primary" @click="addTz">addTz</el-button>
      </el-tab-pane>
      <el-tab-pane label="changeSvcID" name="changeSvcID">
        <el-button class="btn" type="primary" @click="changeSvcID">changeSvcID</el-button>
      </el-tab-pane>
      <el-tab-pane label="change currency" name="change currency">
        <el-form :model="changeCurrencyData" label-width="auto" style="max-width: 600px">
          <el-form-item label="service area id">
            <el-input v-model="changeCurrencyData.svcId" />
          </el-form-item>
          <el-form-item label="from currency">
            <el-input v-model="changeCurrencyData.fromCur" />
          </el-form-item>
          <el-form-item label="to currency">
            <el-input v-model="changeCurrencyData.toCur" />
          </el-form-item>
        </el-form>
        <el-button class="btn" type="primary" @click="changeCurrency">changeCurrency</el-button>
      </el-tab-pane>
      <el-tab-pane label="checkRoutes" name="checkRoutes">
        <!-- <el-button class="btn" type="primary" @click="checkRoutes">checkRoutes</el-button> -->
        <el-button class="btn" type="primary" @click="translateVehicleMapping">translateVehicleMapping</el-button>
      </el-tab-pane>
      <el-tab-pane label="uploadRouteZoneName" name="uploadRouteZoneName">
        <div class="upload-route-zone-box">
          <textarea name="" id="" v-model="inputValueRouteIds"></textarea>
          <el-button class="btn" type="primary" @click="uploadRouteZoneName">uploadRouteZoneName</el-button>
        </div>
      </el-tab-pane>
      <el-tab-pane label="changePricingJson" name="changePricingJson">
        <div class="upload-route-zone-box">
          <el-form :model="changePricingJsonForm" label-width="80px">
            <el-form-item label="from fleet">
              <el-input v-model="changePricingJsonForm.fromSvcId"></el-input>
            </el-form-item>
            <el-form-item label="to fleet">
              <el-input v-model="changePricingJsonForm.toSvcId"></el-input>
            </el-form-item>
            <el-form-item label="replace type">
              <el-checkbox-group v-model="changePricingJsonForm.type">
                <el-checkbox label="zones" name="type"></el-checkbox>
                <el-checkbox label="地推活动" name="type"></el-checkbox>
                <el-checkbox label="线下主题活动" name="type"></el-checkbox>
                <el-checkbox label="单纯品牌曝光" name="type"></el-checkbox>
              </el-checkbox-group>
            </el-form-item>
          </el-form>
          <el-button class="btn" type="primary" @click="changePricingJson">changePricingJson</el-button>
        </div>
      </el-tab-pane>
      <el-tab-pane label="Task" name="fourth">
        <el-button class="btn" type="primary" @click="updateRoute">updateRoute</el-button>
        <el-button class="btn" type="primary" @click="addRoute">addRoute</el-button>
        <el-button class="btn" type="primary" @click="addRoutePrice">addRoutePrice</el-button>
        <el-button class="btn" type="primary" @click="createBarriers">createBarriers</el-button>
        <el-button class="btn" type="primary" @click="setMng">setMng</el-button>
        <el-button class="btn" type="primary" @click="setSpecialDate">setSpecialDate</el-button>
        <el-button class="btn" type="primary" @click="addStrategy">addStrategy</el-button>
        <el-button class="btn" type="primary" @click="updateStrategy">updateStrategy</el-button>
        <el-button class="btn" type="primary"
                   @click="addFleetToRideVehicleMapping">addFleetToRideVehicleMapping</el-button>
        <el-button class="btn" type="primary" @click="addRoutePriceAdj">addRoutePriceAdj</el-button>
        <el-button class="btn" type="primary" @click="syncCost">syncCost</el-button>
        <el-button class="btn" type="primary" @click="checkZonePolygon">checkZonePolygon</el-button>
        <el-button class="btn" type="primary" @click="addToYouXuan">addToYouXuan</el-button>
        <el-button class="btn" type="primary" @click="exDataJson">exDataJson</el-button>
        <el-button class="btn" type="primary" @click="zoneMatchAddr">zoneMatchAddr</el-button>
        <el-button class="btn" type="primary" @click="changeAddr">changeAddr</el-button>
        <el-button class="btn" type="primary" @click="vehicleMapping">vehicleMapping</el-button>
        <el-button class="btn" type="primary" @click="addCost">addCost</el-button>
        <el-button class="btn" type="primary" @click="ctripTop300Handler">ctripTop300Handler</el-button>
        <el-button class="btn" type="primary" @click="getSvcIdbyAirport">getSvcIdbyAirport</el-button>
        <el-button class="btn" type="primary" @click="hoppaAddZones">hoppaAddZones</el-button>
        <el-button class="btn" type="primary" @click="checkRouteTop300">checkRouteTop300</el-button>
        <el-button class="btn" type="primary" @click="getPricingZonesByFleetId">getPricingZonesByFleetId</el-button>
        <el-button class="btn" type="primary" @click="hoppaRoutes2Elifesvc">hoppaRoutes2Elifesvc</el-button>
        <el-button class="btn" type="primary" @click="addSvc">addSvc</el-button>
      </el-tab-pane>
    </el-tabs>
  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="./data/d_tem.js"></script>
<script setup>
  const { createApp, ref, reactive, computed, watch, defineComponent, onMounted } = Vue;
  const stage = 'PROD' //PROD,DEV
  const url = stage == 'PROD' ? urlProd : urlDev
  const crawl_state = '1'

  // let _d = {
  //   curPartnerSvcData: {}, // partner , current service area data
  //   predictionsCache: {}, // Cache search address
  //   originLatLng: { //initial bound lat and lng is sfo's
  //     boundLat: 37.6213129,
  //     boundLng: -122.3789554,
  //     boundRadius: 200000
  //   }
  // }

  const is_active = 11
  const strategy_id = 1

  let i = 0
  let cache = {}
  let partnerJson = null

  const route_type = 0 // 1:smart purchasing routes 
  const batch = 0
  const partnerId = 5
  let dList = stage == 'PROD' ? tem_7_4 : []




  const app = createApp({
    // components: { Parent },

    methods: {

      async addSvc() {
        let title = ['id', 'from_place', 'to_place', 'text', 'platform_name', 'servic area name', 'country', 'new platform_name']
        let arr = []
        for (let item of dList) {

          let { id, from_place, to_place, platform_name, text } = item

          let airportInfoObj = await getAirport(from_place, to_place)
          let { code: airportSearchResCode } = airportInfoObj
          if (airportSearchResCode > 0) {
            console.log(`----${i}-------${id}--`);
            continue

          }
          let { isPickup, airportInfo } = airportInfoObj
          let airportCode = isPickup ? from_place : to_place


          let res = await fetchData({
            url,
            method: 'POST',
            data: {
              sql: 134679330,
              version: '4.087',
              airport: airportCode,
              parent_fleet_id: 15,
            }
          })

          let { airport, ctry, name } = res
          arr.push([id, from_place, to_place, text, platform_name, name, ctry, ''])
          debugger
        }

        let date = new Date()
         saveCSV(`${date.getTime()}`, title, arr)
      },

      async hoppaRoutes2Elifesvc() {

        let res = await getPricingJsonBySvcIdNew(`https://mfmyyv2bjh.execute-api.us-east-2.amazonaws.com/prod/sql-templates/run?ses=${ses}`, 66035)

        console.log(res);



        return
        let arr = []
        // dList = dList.slice(0, 20)
        console.log(dList);
        for (let item of dList) {
          console.log(`----${i++}---`);

          let Row_Labels = item['Row Labels']
          let route_id = item['route_id']
          let From_Address = item['From Address']
          let To_Address = item['To Address']
          let svcId = item['service area id']



          // if (svcId != "no fleet id") {
          //   arr.push([
          //     Row_Labels,
          //     route_id,
          //     From_Address,
          //     To_Address,
          //     svcId
          //   ])
          //   continue
          // }

          const regex = /\(([A-Z]{3})\)$/;
          const match = From_Address.match(regex) || To_Address.match(regex)
          let airportCode = ''
          if (match) {
            airportCode = match[1]; // 结果: "ALC"
          }
          let res = await getFleetIdByAirport(url, airportCode, 15)

          let fleet_id = res.fleet_id || 0

          if (fleet_id == 0) {
            debugger
            let fromList = await getAddrList(From_Address)
            let toList = await getAddrList(To_Address)


            let from_place_id = fromList[0]?.place_id || 0
            let to_place_id = toList[0]?.place_id || 0

            if (!to_place_id || !from_place_id) {
              arr.push([
                Row_Labels,
                route_id,
                From_Address,
                To_Address,
                0
              ])
              continue
            }


            let fd = await getDetailByPlaceId(from_place_id)
            let td = await getDetailByPlaceId(to_place_id)
            if (!fd || !td) {
              arr.push([
                Row_Labels,
                route_id,
                From_Address,
                To_Address,
                0
              ])
              continue
            }

            let { lat: from_lat, lng: from_lng } = fd
            let { lat: to_lat, lng: to_lng } = td


            let d = {
              from_lat,
              from_lng,
              to_lat,
              to_lng,
              // demand_fleet_id: 11104,
              // supply_fleet_id: 89496
            }


            let fleets = await getPriceByLatLng(d)
            fleet_id = fleets[0]?.fleet_id || 0

          }



          arr.push([
            Row_Labels,
            route_id,
            From_Address,
            To_Address,
            fleet_id
          ])
        }

        debugger
        let title = ['Row Labels', 'route_id', 'From Address', 'To Address', 'service area id']
        let date = new Date()
        saveCSV(date, title, arr)

      },


      async getPricingZonesByFleetId() {
        // select * from fleet where id in () and parent_fleet_id = 89496

        let ids = [89694, 90331, 90407, 89704, 89777, 89815, 89753, 89894, 90769, 90080, 90099, 90107, 90175, 90176, 90187, 90368, 89660, 89706, 90348, 95413, 90337, 90400, 90451, 89950, 89740, 90589, 90591, 90876, 89815, 90490, 90774, 90773, 90746, 90317, 90797, 90883, 90882, 90972, 90979, 90952, 90953, 90214, 91028]

        let obj = {}
        for (let id of ids) {
          let json = await getLastPricingJsonBySvcId(url, id)

          obj[id] = json?.zones || []

        }
        console.log(obj);
      },


      async checkRouteTop300() {

        let obj = {}
        for (let p of this.partnerIds) {
          let { id } = p
          let arr = []
          let arr_1 = []
          for (let item of dList) {
            let { from_zone, to_zone } = item
            let routeInfo = await getRoute(url, from_zone, to_zone, id)
            let { id: routeId } = routeInfo
            if (routeId) {
              arr.push(routeId)
            } else {
              arr_1.push(item)
            }
          }

          obj[id] = {
            exists: arr,
            no_exists: arr_1
          }

        }

        console.log(obj);


      },

      async changePricingJson() {
        let { fromSvcId, toSvcId, type } = this.changePricingJsonForm
        let op = await getPricingJsonBySvcId(url, fromSvcId)
        let tp = await getPricingJsonBySvcId(url, toSvcId)
        // console.log(JSON.parse(JSON.stringify(tp)));
        // let replaceFields = ['zones']
        // for (let item of type) {
        //   tp[item] = op[item]
        // }

        op['serviceArea'] = tp['serviceArea']
        delete op.service_area_pricing_id


        // let tp ={}
        // let toSvcId = 14147


        let str = JSON.stringify(op)
        str = str.replace(/\'/g, ' ')
        console.log(JSON.parse(str));
        let updateD = {
          sql: 134678780,
          version: '1.0',
          pricing_str: str,
          new_fleet_id: toSvcId
        }

        debugger
        // insert into service_area_pricing (service_area_id,pricing,effective_at,expire_at) 
        // values  ({{new_fleet_id}},'{{pricing_str}}','2024-04-08 05:05:00','2037-12-31 23:59:59' );
        // update fleet set service_area_pricing_id = last_insert_id() where id = {{new_fleet_id}} limit 1;
        let res = await fetchData({
          url,
          method: 'POST',
          data: updateD,
          desc: 'update json'
        })

        debugger
      },

      hoppaAddZones() {
        let pricingJSON = {}
        let { vehicleClasses, zone2zone } = pricingJSON

        let z2zList = zone2zone?.prices || []

        for (let item of dList) {
          let priceStr = item['Final Prices']
          let from = item['From Zone']
          let to = item['To Zone']
          let FC = item['From Cluster Center']
          let TC = item['To Cluster Center']
          let FE = item['Final Prices Elife Vehicles']
          FE = JSON.parse(FE.replace(/'/g, '"'))

          let arr = []
          let arrPrices = []
          for (let [key, value] of Object.entries(FE)) {
            let vehicle = vehicleList.find(o => o.vehicle_name == key)
            let { vehicle_id, vehicle_name } = vehicle

            arr.push({
              vehicle_id,
              vehicle_name,
              value
            })
            if (![119, 120, 121].includes(vehicle_id)) {
              arrPrices.push(value)
            }
          }


          let lowestPrice = arr.find(o => o.vehicle_id == 1)?.value || 0
          if (!lowestPrice) {
            lowestPrice = Math.min(...arrPrices)
          }

          if (from == 'DXB' || to == 'DXB') {
            if (from.includes('New Cluster') || to.includes('New Cluster')) {
              console.log(`-------${i++}--------`);

              if (to == 'New Cluster 0' || to == 'New Cluster 8') {
                debugger
                continue
              }

              let TCArr = TC.substring(1, TC.length - 1).split(',')
              pricingJSON.zones.push({
                "name": to,
                "lat": Number(TCArr[0]),
                "lng": Number(TCArr[1]),
                "radius": 5000,
                "prices": [
                  {
                    "airport": from,
                    "amount": lowestPrice,
                    "currency": "USD",
                    "p_amt": lowestPrice,
                    "d_amt": lowestPrice
                  }
                ],
                "p2p": "false"
              })

              let len = pricingJSON.zones.length


              for (let item of arr) {
                let { vehicle_id, value, vehicle_name } = item
                debugger
                let v = vehicleClasses.find(o => o.vehicle_class_id == vehicle_id)
                if (!v) {
                  let delta_amount = Number((value - lowestPrice).toFixed(2))
                  let newVehicle = {
                    "vehicle_class_id": vehicle_id,
                    "delta_amount": 0,
                    "percent": 0,
                    "hourly_percent": 0,
                    "percent_appendix": [
                      {
                        field: `zones.${len - 1}.prices.0.p_amt`,
                        delta_amount: delta_amount
                      },
                      {
                        field: `zones.${len - 1}.prices.0.d_amt`,
                        delta_amount: delta_amount
                      },
                    ],
                    "surcharge_schedule": []
                  }
                  vehicleClasses.push(newVehicle)

                } else {
                  if (!v.percent_appendix) {
                    v['percent_appendix'] = []
                  }
                  let delta_amount = Number((value - lowestPrice).toFixed(2))

                  let pAmtIdx = v.percent_appendix.findIndex(o => o.field == `zones.${len - 1}.prices.0.p_amt`)
                  let dAmtIdx = v.percent_appendix.findIndex(o => o.field == `zones.${len - 1}.prices.0.d_amt`)
                  if (pAmtIdx == -1) {
                    v.percent_appendix.push(
                      {
                        field: `zones.${len - 1}.prices.0.p_amt`,
                        delta_amount: delta_amount
                      }
                    )
                  } else {
                    v.percent_appendix[pAmtIdx].delta_amount = delta_amount
                  }
                  if (dAmtIdx == -1) {
                    v.percent_appendix.push(
                      {
                        field: `zones.${len - 1}.prices.0.d_amt`,
                        delta_amount: delta_amount
                      }
                    )
                  } else {
                    v.percent_appendix[dAmtIdx].delta_amount = delta_amount
                  }
                }
              }



            }
          }

          // zone2zone
          if (from == '市区' && to == '朱美拉') {

            let index = z2zList.findIndex(o => o.from_zone == from && o.to_zone == to)
            let isExist = false

            if (!zone2zone) {
              pricingJSON['zone2zone'] = {
                "mac": 1,
                "prices": []
              }
            }

            if (index != -1) {
              isExist = true
              z2zList[index].amount = lowestPrice
            } else {
              index = z2zList.length
              pricingJSON['zone2zone']['prices'].push({
                "name": `${from}-${to}`,
                "from_zone": `${from}`,
                "to_zone": `${to}`,
                "amount": `${lowestPrice}`,
                "reverse": "1"
              })
            }

            for (let v of vehicleClasses) {
              let { vehicle_class_id } = v
              if (!v.percent_appendix) {
                v['percent_appendix'] = []
              }

              let vehiclePrice = arr.find(o => o.vehicle_id == vehicle_class_id)
              if (!vehiclePrice) {
                continue
              }
              let { value } = vehiclePrice

              let delta_amount = Number((value - lowestPrice).toFixed(2))
              let z2zDelta = v.percent_appendix.find(o => o.field == `zone2zone.prices.${index}`)
              if (!z2zDelta) {
                v.percent_appendix.push(
                  {
                    field: `zone2zone.prices.${index}`,
                    delta_amount
                  })
              } else {
                z2zDelta.delta_amount = delta_amount
              }
            }
          }
        }

        console.log(pricingJSON);

        console.log(`-------------------END-------------------`);
      },

      async getSvcIdbyAirport() {
        let airports = ['AMS', 'GRQ', 'BER', 'DUS', 'EDI']

        let arr = []
        for (let airport of airports) {
          let res = await getFleetIdByAirport(url, airport, 75362)
          let { fleet_id } = res
          if (!fleet_id) {
            fleet_id = 'aaaa'
          }

          let index = arr.findIndex(o => o.id == fleet_id)
          debugger
          if (index == -1) {
            arr.push({
              id: fleet_id,
              percent: 40
            })
          }


        }

        console.log(arr);

      },

      async addCost() {

        for (let item of dList) {
          console.log(`-------${i++}--------`);

          let { id, route_id, vehicle_class_id, cost, profit, mng, sla, partner_markup, max, is_active } = item

          let costs = {
            route_id,
            vehicle_class_id,
            cost,
            profit: 0
            // mng,
            // sla,
            // partner_markup,
            // max,
            // is_active
          }
          let res = await insertCost(url, [costs])
          debugger

        }
      },

      vehicleMapping() {
        let arr = [['ctrip vehicle id', 'ctrip vehicle class', 'elife vehicle id', 'elife vehicle class']]

        let title = ['ctrip vehicle id', 'ctrip vehicle class', 'elife vehicle id', 'elife vehicle class']

        // 创建工作簿
        const wb = XLSX.utils.book_new();

        for (let item of vehicle_type_mapping) {
          let { countries, mapping } = item
          for (let c of countries) {

            let sheetData = []
            sheetData.push(title)
            for (let m of mapping) {
              let { elife, china_ctrip_api } = m
              let ctrip = x_ctrip.find(o => o['车型id'] == china_ctrip_api)
              let elifeVehicle = vehicleList.find(o => o.vehicle_id == elife)
              console.log(`--------${i++}----------------------------`);


              let ct = ctrip ? ctrip['携程车型'] : ''
              let ci = ctrip ? ctrip['车型id'] : ''
              let { vehicle_name, vehicle_id } = elifeVehicle
              arr.push([ci, ct, vehicle_id, vehicle_name])
              sheetData.push([ci, ct, vehicle_id, vehicle_name])

            }

            const ws1 = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws1, c);
          }


        }

        XLSX.writeFile(wb, '多工作表示例.xlsx');
        // let date = new Date()
        // downLoadCSV(arr, `${date.getTime()}`)
      },


      async ctripTop300Handler() {
        let arr = []
        for (let item of dList) {

          console.log(`-------${i++}--------`);
          let svcName = item['Service Area']
          let svcList = svc3.filter(o => o['svc_name'] == svcName)
          if (!svcList.length) continue

          for (let svc of svcList) {
            let { remark, from_zone } = svc

            let res = await getAirportInfo(url, from_zone)
            svc['country'] = res.ctry


            let aa = remark.replace(/\\"/g, '')
            let bb = aa.replace(/""/g, '"')
            svc['remark'] = bb

            arr.push(svc)
          }
        }
        let date = new Date()
        downLoadCSV(arr, `ctrip-top300aa`)

      },

      async zoneMatchAddr() {
        let arr = []
        for (let item of dList) {
          let { id: fleet_id } = item
          let svcName = item['Service Area']
          if (!fleet_id) {
            let res = await getFleetByName(url, svcName, 61654)
            fleet_id = res.id
          }
          if (!fleet_id) {
            item['note'] = 'no service area'
            this.noInsertList.push(item)
            continue
          }



          debugger
          console.log(`-----${i++}----`, fleet_id);
          let pricingJson = await getPricingJsonBySvcId(url, fleet_id)
          if (!pricingJson) {
            itme['note'] = 'no pricing json'
            this.noInsertList.push(item)
            continue
          }
          let { zones, airports, serviceArea: { id, name } } = pricingJson
          if (!zones.length) {
            console.log('--------continue---------');
            debugger
            continue
          }
          for (let airport of airports) {
            let airportInfo = await getAirportInfo(url, airport)
            let airportAddr = await getAddrFromLatLng(airportInfo)

            let flight_infos = await getFlightNoByAiportCode(urlDev, airport, 8, 18)
            if (!flight_infos) {
              flight_infos = await getFlightNoByAiportCode(urlDev, airport)
            }
            console.log(flight_infos);
            const uniqueFlights = flight_infos.results.filter((flight, index, self) =>
              index === self.findIndex(f => f.from_airport === flight.from_airport)
            );

            if (!uniqueFlights.length) {
              item['note'] = 'no flight info'
              this.noInsertList.push(item)
              continue
            }

            let { from_airport, to_airport } = uniqueFlights[0]

            let remark = {
              zone_name: ''
            }
            if (from_airport) {
              remark['from_airport'] = from_airport
            }
            if (to_airport) {
              remark['to_airport'] = to_airport
            }

            let flights = []
            for (let flight of uniqueFlights) {
              let { flight_code, flight_number, from_airport, to_airport } = flight
              flights.push({
                from_airport,
                to_airport,
                flight_no: `${flight_code}${flight_number}`
              })
            }
            remark['ctrip_flight_list'] = flights

            for (z of zones) {
              let zoneAddr = await getAddrFromLatLng(z)

              remark['zone_name'] = z.name

              arr.push({
                svc_id: id,
                svc_name: name,
                from_zone: airport,
                to_zone: z.name,
                from_address: airport,
                to_address: zoneAddr,
                partner_id: 2621,
                route_type: '接机',
                remark: JSON.stringify(remark)
              })
              debugger
            }
          }
          debugger
        }

        let date = new Date()
        downLoadCSV(arr, `ctrip-top300`)
      },

      async exDataJson() {
        let ids = [89690, 89668, 90021, 90022, 90700, 90802]

        let arr = []
        let jsons = []
        for (let svcId of ids) {
          let pricngJson = await getPricingJsonBySvcId(url, svcId)
          if (!pricngJson) {
            arr.push(svcId)
          }

          let { zones, serviceArea: { id } } = pricngJson

          jsons.push({
            service_area_id: id,
            zones
          })



        }
        console.log(jsons);
      },

      async translateVehicleMapping() {


        let ctripMapping = {}

        // let defaultVehicles = get

        for (let item of vehicle_type_mapping) {
          let { countries, mapping } = item
          console.log(item);
          if (!countries) {
            continue
          }

          if (countries[0] == 'DEFAULT') {
            debugger
          }

          console.log(`--------${i++}----${countries}------------------------`);
          debugger
          for (let c of countries) {
            let res = await this.runSQL({
              sql: 134678012,
              version: '1.3',
              country_code: `${c}`
            })


            let vehicles = res.results
            ctripMapping[`${c}`] = []
            for (let m of mapping) {
              let { elife: vid, china_ctrip_api } = m
              let curVehicle = vehicles.find(o => o.vehicle_id == vid)

              if (!curVehicle || c == 'DEFAULT') {
                debugger
                curVehicle = vehicleList.find(o => o.vehicle_id == vid)
              }
              let { vehicle_name, o_max_passenger, o_maker, o_model, o_image_url, o_image_url_2, o_max_luggage, maker, model, max_passenger, max_luggage, image_url_1, image_url_2, maker_txt_id, model_txt_id } = curVehicle

              let partnerVehicle = x_ctrip.find(o => o["车型id"] == china_ctrip_api)
              let pvName = 'xxxx'
              if (partnerVehicle) {
                pvName = partnerVehicle['携程车型']
              }
              ctripMapping[`${c}`].push(
                {
                  "id": this.uuid(),
                  "vehicle_class_id": vid,
                  "vehicle_class": vehicle_name,
                  "maker": "",
                  "model": "",
                  "max_passengers": "",
                  "min_passengers": "",
                  "max_luggage": "",
                  "min_luggage": "",
                  "image_url_1": "",
                  "image_url_2": "",
                  "x_vehicle_class_id": '',
                  "x_maker": "",
                  "x_model": "",
                  "x_max_luggage": "",
                  "x_min_luggage": "",
                  "x_vehicle_class": "",
                  "x_max_passengers": "",
                  "x_min_passengers": "",
                  "x_vehicle_category": "", // only mozio
                  "x_vehicle_class": pvName
                }
              )
            }

          }
        }



        console.log(JSON.stringify(ctripMapping));


      },

      uuid() {
        function S4() {
          return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1)
        }
        return S4() + '-' + S4() + '-' + S4()
      },

      async uploadRouteZoneName() {
        let ids = this.inputValueRouteIds
        if (!ids) return
        let d = {
          "sql": 134679330,
          "version": "4.061",
          ids
        }
        let routes = await this.runSQL(d)

        for (let item of routes.results) {
          let { id, from_place, to_place, partner_id } = item
          let { parentFleetId, platform_name } = getPatnerInfo(partner_id, stage)
          await this.addRouteHandle(item, parentFleetId, partner_id, platform_name)
        }

        console.log('--noInsertList--', this.noInsertList);
        console.log('--doneList--', this.doneList);
        console.log('--this.existsIds--', this.existsIds);
        console.log('--this.newRouteIds--', this.newRouteIds);



        let date = new Date()
        downLoadCSV(this.noInsertList, `${date.getTime()}- no insert list`)

      },

      async addToYouXuan() {
        ids = []
        for (let id of ids) {
          let d = {
            sql: 134679330,
            version: '4.062',
            route_id: id,
            pre_percent: 0.1
          }

          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })
        }
      },

      async checkZonePolygon() {
        let { parentFleetId, partner_id, platform_name } = getPatnerInfo(partnerId, stage)
        for (let item of dList) {
          let { id, name, service_area_pricing_id } = item
          console.log(`-----${i++}-----------`, id, '---', name, this.noInsertList);


          let pricingJson = await getPricingJsonBySvcId(url, id)
          if (!service_area_pricing_id) {
            pricingJson = await getLastPricingJsonBySvcId(url, id)
          }

          if (!pricingJson) {
            console.log('--------continue---------');
            continue
          }

          let { zones } = pricingJson
          if (!zones) continue

          for (let z of zones) {
            let { polygons } = z
            if (!polygons) continue
            let flag = hasSelfIntersect(polygons)
            if (flag) {
              this.noInsertList.push({
                id,
                "service area": name,
                zone_name: z.name,
                note: 'zone has self intersect'
              })
            }
          }
        }

        let date = new Date()
        downLoadCSV(this.noInsertList, `${platform_name}-${date.getTime()}- zone has self intersect`)

      },

      async syncCost() {

        let d = {
          "version": "4.053",
          "countries": `"ABW","TUR"`
        }

        let aa = await this.runSQL(d)


        console.log(dList);

        for (let item of dList) {
          let { from_place, to_place, id } = item
          let str = `${from_place}-${to_place}`
          let num = cache[str]
          if (num) continue
          cache[str] = 1
          let ids = dList.filter(obj => obj.from_place == from_place && obj.to_place == to_place).map(o => o.id)
          let { results: allVehicleCost } = await this.getCost(ids.join(','), '4.015')
          for (let id of ids) {
            console.log(`----------${i++}--${id}--`);

            let res = await this.getCost(`${id}`, '4.015')
            let costs = res.results || []
            for (let c of costs) {
              let vc = allVehicleCost.find(item => item.vehicle_class_id == c.vehicle_class_id)
              c['cost'] = vc['cost']
            }
            console.log(costs);
            let insertCostRes = await insertCost(url, costs)
          }
        }
      },


      async checkRoutes() {
        console.log(dList);

        for (let item of dList) {
          console.log(`-------${i++}------`);
          let { from_place, to_place, from_address, to_address, partner_id } = item

          if (from_address.length == 3) {
            from_address = `${from_address} Airport`
          }
          if (to_address.length == 3) {
            to_address = `${to_address} Airport`
          }

          let fromList = await this.getAddrList(from_address)

          if (!fromList.length) {
            let obj = JSON.parse(JSON.stringify(item))
            obj['note'] = 'can not get from address info'
            this.noInsertList.push(obj)
            continue
          }

          let { place_id: from_place_id } = fromList[0]
          let fromDetail = await this.getDetailByPlaceId(from_place_id)

          let toList = await this.getAddrList(to_address)
          if (!toList.length) {
            let obj = JSON.parse(JSON.stringify(item))
            obj['note'] = 'can not get from address info'
            this.noInsertList.push(obj)
            continue
          }
          let to_place_id = toList[0].place_id
          let toDetail = await this.getDetailByPlaceId(to_place_id)

          let { lat: fLat, lng: fLng } = fromDetail
          let { lat: tLat, lng: tLng } = toDetail

          let { demand_fleet_id, supply_fleet_id } = getPatnerInfo(partner_id, stage)
          let res = await this.getPriceElife(fLat, fLng, tLat, tLng, demand_fleet_id, supply_fleet_id)
          let vehiclePrice = res[0]
          let { from, to, from_type, to_type } = vehiclePrice?.price_detail?.base_pricing?.fix_price_detail || {}
          if (from != from_place || to != to_place) {
            let obj = JSON.parse(JSON.stringify(item))
            obj['note'] = 'fixed price zone not match'
            this.noInsertList.push(obj)
            continue
          }

          this.doneList.push(item)
        }

        let date = new Date()
        downLoadCSV(this.noInsertList, `${date.toLocaleString()}- no insert list`)
        downLoadCSV(this.doneList, `${date.toLocaleString()}- doneList list`)
      },



      async addFleetToRideVehicleMapping() {

        // let d = {
        //   sql: 134679330,
        //   version: '4.049',
        //   vehicle_ids: [36, 1, 2, 3, 4, 6, 40, 41, 12, 13, 14, 7, 43, 42, 48, 49, 52, 100, 5, 102, 103, 101, 104, 105, 106, 108],
        //   to_vehicle_id: 109
        // }

        let d = {
          sql: 134679330,
          version: '4.086',
          from_vehicle_id: 125,
          to_vehicle_ids: [8, 7, 11, 10, 9, 6, 5, 3, 123, 124, 125]
        }
        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })

      },

      async changeCurrency() {
        let { fromCur, toCur, svcId } = this.changeCurrencyData
        console.log(fromCur, toCur, svcId);
        let ids = svcId.split(',')
        for (let fleetId of ids) {
          debugger
          console.log(`-------${i++}--------`);
          let pricingJson = await getLastPricingJsonBySvcId(url, fleetId)
          if (!pricingJson) {
            this.noInsertList.push({
              fleetId,
              note: 'do not have service area pricing'
            })
            continue
          }
          console.log('--befor--', pricingJson);
          let rate = await getCurrencyRates(fromCur, toCur)
          const targetFields = ["min_amount", "amount", 'delta_amount', 'meet_n_greet', "p_amt", "d_amt"];
          let changedJson = this.updateFields(JSON.parse(JSON.stringify(pricingJson)), targetFields, rate, toCur)
          changedJson['currencyCode'] = toCur
          console.log('----changed---', changedJson);

          let pricingStr = JSON.stringify(changedJson)
          pricingStr = pricingStr.replace(/\'/g, ' ')
          let res = await insertAndUpdate(url, pricingStr, fleetId)

          debugger
          let total_affected_rows = res?.['total_affected_rows'] || 0
          if (!total_affected_rows) {
            this.noInsertList.push({
              fleetId,
              note: 'Insert error'
            })
          }
        }

        let date = new Date()
        downLoadCSV(this.noInsertList, `no insert list`)
        downLoadCSV(this.doneList, `doneList`)
      },




      updateFields(obj, targetFields, rate, currencyCode) {
        if (typeof obj === "object" && obj !== null) {
          for (let key in obj) {
            if (key == 'currency') {
              obj[key] = currencyCode
            }
            if (targetFields.includes(key) && typeof obj[key] === "number") {
              obj[key] = Number((Number(obj[key]) * rate).toFixed(2));
            } else if (typeof obj[key] === "object") {
              this.updateFields(obj[key], targetFields, rate, currencyCode);
            }
          }
        }
        return obj
      },

      async changeSvcID() {
        let { partnerInfo, parentFleetId } = getPatnerInfo(partnerId, stage)
        for (let r of dList) {
          console.log(`-----${i++}----`);
          let { id, from_place, to_place } = r
          let airportInfoObj = await getAirport(from_place, to_place)
          let { code: airportSearchResCode } = airportInfoObj
          if (airportSearchResCode > 0) {
            if (airportSearchResCode == 1) {
              item['note'] = 'No  airport'
            } else {
              item['note'] = 'From and to are both airports'
            }
            this.noInsertList.push(item)
            continue
          }
          let { isPickup, airportInfo } = airportInfoObj
          let airportCode = isPickup ? from_place : to_place

          let str = `${parentFleetId}-${airportCode}`
          let fleetInfo = cache[str]
          if (!fleetInfo) {
            fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)

          }
          let { fleet_id, pricing, pricing_id } = fleetInfo
          if (!fleet_id) {
            item['note'] = 'NO fleet'
            this.noInsertList.push(item)
            continue
          }

          cache[str] = fleetInfo

          let d = {
            sql: 134679330,
            version: '4.045',
            is_active: '99',
            service_area_id: fleet_id,
            ids: `${id}`,
          }
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })

          let num = res['Affected rows']
          if (num != 1) {
            item['note'] = 'inser error'
            this.noInsertList.push(item)
          }

        }

        console.log('--noInsertList--', this.noInsertList);
        console.log('--doneList--', this.doneList);
        console.log('--this.existsIds--', this.existsIds);
        console.log('--this.newRouteIds--', this.newRouteIds);



        let date = new Date()
        downLoadCSV(this.noInsertList, `${parentFleetId}-${date.toLocaleString()}- no insert list`)

      },




      getDisableDate(pricingJson) {
        let specialCharge = pricingJson?.specific_date_surcharge || []
        let arr = []
        for (let item of specialCharge) {
          let { from_date, to_date } = item
          if (!from_date || !to_date) continue
          arr.push(`${from_date}/${to_date}`)
        }
        let dateStr = arr.join(',')
        return dateStr
      },

      async setSpecialDate() {
        for (let route of dList) {
          console.log(`------${i++}-----`);

          let { id, service_area_id } = route
          let dateStr = cache[service_area_id]
          if (!dateStr) {
            // let pricingJson = await getLastPricingJsonBySvcId(url, service_area_id)
            let specialCharge = pricingJson?.specific_date_surcharge || []
            let arr = []
            for (let item of specialCharge) {
              let { from_date, to_date } = item
              if (!from_date || !to_date) continue
              arr.push(`${from_date}/${to_date}`)
            }
            dateStr = arr.join(',')
            cache[service_area_id] = dateStr
          }

          let d = {
            sql: 134679330,
            version: '4.045',
            is_active: '99',
            disable_date: dateStr,
            ids: `${id}`,
          }
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })
        }
      },

      async updateRoute() {
        let ids = [

          8282, 8283, 9977, 9978, 9979, 9980, 9981, 9982, 9983, 9984, 9985, 9986, 9987, 9988, 9989, 9990, 9991, 9992, 9993, 9994, 9995, 9996
        ]

        console.log(ids);

        let idsStr = ids.join(',')

        let url = urlProd   // urlDev,urlProd
        let d = {
          sql: 134679330,
          version: '4.079',
          ids: idsStr,
          cost: 1,
          // route_type:'3',
          // level: "2",
          is_active: '99',
          // tz,
          batch: '39',
          // strategy_id: 1,
          // crawl_state:'0',
          // platform_name:'m.ctrip.com',
          // from_address: addressHandler('Chhatrapati Shivaji International Airport Mumbai'),
          // to_address: addressHandler('Grand Hyatt Mumbai Hotel & Residences'),
          // from_place: "千叶",
          // "json": '{"d_amt":"zones.1.prices.0.d_amt"}',
          // "to_place":"Madhapur",
          // "from_place": "Madhapur",
          // "partner_id": 2593,
          // "platform_name": "Amadeus",

        }
        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })
        return res
      },

      async changeAddr() {
        for (let item of dList) {
          let id = item['线路id']
          let from = item['new address from']
          let to = item['new address to']
          console.log(`-------${i++}--------`);

          let d = {
            sql: 134679330,
            version: '4.045',
            is_active: '99',
            batch: '28',
            from_address: addressHandler(from),
            to_address: addressHandler(to),
            ids: id,
          }
          debugger
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })


        }
      },


      async copyRoute() {
        let { ids, partnerId: partner_id } = this.form

        if (!partner_id || !ids) return
        let idsArr = ids.split(',')
        console.log(idsArr, partner_id);
        let { platform_name, parentFleetId } = getPatnerInfo(Number(partner_id), stage)
        for (let id of idsArr) {
          console.log(`----------${i++}----------`);
          let item = await getRouteById(url, id)

          let insertRes = await this.addRouteHandle(item, parentFleetId, partner_id, platform_name, isCopy = true)
          if (!insertRes) {
            continue
          }

          let { from_place, to_place } = item
          let checkAirport = await getAirport(from_place, to_place)
          let { isPickup, airportInfo } = checkAirport
          let airportCode = isPickup ? from_place : to_place


          let fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)
          let { pricing } = fleetInfo
          let pricingJson = JSON.parse(pricing)


          let { lastId } = insertRes
          if (lastId) {
            let originalCost = await getCostProfit(url, id)
            let costs = []
            let prices = []
            for (let c of originalCost.results) {
              c['route_id'] = lastId
              delete c['cost_id']
              if (!c['profit']) {
                c['profit'] = '0'
              }
              costs.push(c)
              let { vehicle_class_id } = c
              let jsonHandled = jsonHandler3(pricingJson, from_place, to_place, isPickup, airportInfo, vehicle_class_id)
              let { pAmt } = jsonHandled
              if (!pAmt) continue
              prices.push({
                price: pAmt,
                route_id: lastId,
                vehicle_class_id
              })
            }
            console.log(prices);
            console.log(costs);
            let insertCostRes = await insertCost(url, costs)
            let insertAdjRes = await insertAdj(url, prices)
          }

        }
        this.form = {
          ids: '',
          partnerId: '',
        }
        let date = new Date()
        downLoadCSV(this.noInsertList, `${parentFleetId}-${date.toLocaleString()}- no insert list`)
      },




      async addRoutePriceAdj() {


        for (let item of dList) {
          console.log(`---------${i++}---------------`);
          let { route_id, vehicle_class_id, price } = item


          let arr = [
            {
              route_id,
              vehicle_class_id,
              price
            }
          ]

          debugger

          let insertAdjRes = await insertAdj(url, arr)

          debugger
        }
        // let vehicles = getVehicles()
        // for (let route of dList) {
        //   debugger
        //   console.log(`-------${i++}--------`);

        //   let { id: routeId, from_zone: fz, to_zone: tz, service_area_id, from_place, to_place, partner_id } = route
        //   let from_zone = fz ? fz : from_place
        //   let to_zone = tz ? tz : to_place

        //   debugger

        //   let { parentFleetId, platform_name } = getPatnerInfo(partner_id, stage)

        //   let airportInfoObj = await getAirport(from_zone, to_zone)
        //   if (!airportInfoObj) {
        //     item['note'] = 'No  airport'
        //     this.noInsertList.push(item)
        //     continue
        //   }
        //   let { isPickup, airportInfo } = airportInfoObj
        //   let airportCode = isPickup ? from_zone : to_zone

        //   let str = `${parentFleetId}-${airportCode}`
        //   let fleetInfo = cache[str]
        //   if (!fleetInfo) {
        //     fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)
        //   }

        //   let { fleet_id, pricing, pricing_id } = fleetInfo
        //   if (!fleet_id) {
        //     item['note'] = 'NO fleet'
        //     this.noInsertList.push(item)
        //     continue
        //   }
        //   cache[str] = fleetInfo


        //   let pricingJson = JSON.parse(pricing)
        //   let prices = []

        //   for (let vehicleInfo of vehicles) {
        //     let { name: v, id } = vehicleInfo

        //     let curvehicle = vehicleList.find(vehicle => vehicle.vehicle_name == v)

        //     if (!curvehicle) {
        //       debugger
        //       continue
        //     }
        //     let vid = curvehicle.vehicle_id

        //     let jsonHandled = jsonHandler3(pricingJson, from_zone, to_zone, isPickup, airportInfo, vid)
        //     if (!jsonHandled) {
        //       item['note'] = 'no Fixed Price Zone'
        //       this.noInsertList.push(item)
        //       continue
        //     }
        //     let { pAmt } = jsonHandled
        //     console.log('--', routeId, '--', v, '--', vid, '----', pAmt);
        //     if (pAmt) {
        //       prices.push({
        //         route_id: routeId,
        //         vehicle_class_id: vid,
        //         price: pAmt
        //       })
        //     }
        //   }

        //   let insertAdjRes = await insertAdj(url, prices)
        // }

      },



      async addRoutePrice() {
        let vehicles = getVehicles()
        let cStr = ' Cost'
        let pStr = ' min profit'
        let mStr = ' Max'

        let { parentFleetId, platform_name } = getPatnerInfo(partnerId, stage)
        console.log(dList);

        let i = 0
        for (let item of dList) {
          let { from_zone: fz, to_zone: tz, service_area_id, from_place, to_place, partner_id } = item


          let from_zone = fz ? fz : from_place
          let to_zone = tz ? tz : to_place
          console.log(`-------${i++}---${from_zone}--${to_zone}---`);

          if (!from_zone || !to_zone) {
            this.noInsertList.push(item)
            continue
          }

          debugger

          let { id: routeId } = await getRoute(url, from_zone, to_zone, partnerId)

          if (!routeId) {
            item['note'] = 'no route'
            this.noInsertList.push(item)
            continue
          }

          let airportInfoObj = await getAirport(from_zone, to_zone)
          if (!airportInfoObj) {
            item['note'] = 'No  airport'
            this.noInsertList.push(item)
            continue
          }
          let { isPickup, airportInfo } = airportInfoObj
          let airportCode = isPickup ? from_zone : to_zone

          let str = `${parentFleetId}-${airportCode}`
          let fleetInfo = cache[str]
          if (!fleetInfo) {
            fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)
          }

          let { fleet_id, pricing, pricing_id } = fleetInfo
          if (!fleet_id) {
            item['note'] = 'NO fleet'
            this.noInsertList.push(item)
            continue
          }
          cache[str] = fleetInfo

          let routeStr = `route-${from_zone}-${to_zone}`

          let sameRoutes = cache[routeStr]
          if (!sameRoutes) {
            let res = await this.runSQL({
              version: '1.10',
              from_place: from_zone,
              to_place: to_zone
            })
            sameRoutes = res?.results || []
          }
          debugger

          let costStr = `cost-${from_zone}-${to_zone}`
          let sameCosts = cache[costStr] || []
          if (sameRoutes.length && sameCosts.length == 0) {
            let ids = []
            for (let r of sameRoutes) {
              ids.push(r.route_id)
            }
            let res = await this.runSQL({
              version: '4.015',
              route_id: ids.join(','),
            })
            sameCosts = res.results
          }


          let pricingJson = JSON.parse(pricing)
          let costs = []
          let prices = []
          for (let vehicleInfo of vehicles) {
            let { name: v, id } = vehicleInfo

            let cost = sameCosts.find(sc => sc.vehicle_class_id == id)?.cost
            if (!cost) {
              let costStr = item[`${v}${cStr}`]
              if (costStr == undefined) continue
              cost = Number(costStr.replace(/\$/g, '').replace(/\,/g, '')) || 1000
            }

            if (!cost) {
              item['note'] = 'no cost'
              this.noInsertList.push(item)
              continue
            }

            let profit = item[`${v}${pStr}`]
            let max = item[`${v}${mStr}`]


            if (!profit) {
              profit = '0'
            }
            profit = Number(profit.replace(/\%/g, '')) / 100
            if (!profit) {
              profit = '0'
            }
            if (max) {
              max = Number(max.replace(/\$/g, ''))
            }

            let curvehicle = vehicleList.find(vehicle => vehicle.vehicle_name == v)

            if (!curvehicle) {
              debugger
              continue
            }
            let vid = curvehicle.vehicle_id

            let jsonHandled = jsonHandler3(pricingJson, from_zone, to_zone, isPickup, airportInfo, vid)
            if (!jsonHandled) {
              item['note'] = 'no Fixed Price Zone'
              this.noInsertList.push(item)
              continue
            }
            let { pAmt } = jsonHandled
            console.log('--', routeId, '--', v, '--', vid, '----', cost, '---', profit, '--', max, '---', pAmt);
            if (pAmt && cost) {
              let obj = {
                route_id: routeId,
                vehicle_class_id: vid,
                cost,
                profit
              }

              if (max) {
                obj['max'] = max
              }
              prices.push({
                route_id: routeId,
                vehicle_class_id: vid,
                price: pAmt
              })

              costs.push({
                route_id: routeId,
                vehicle_class_id: vid,
                cost,
                profit
              })
            }
            this.doneList.push(routeId)
          }

          let insertCostRes = await insertCost(url, costs)
          let insertAdjRes = await insertAdj(url, prices)
        }

        console.log('--this.noInsertList--', this.noInsertList);
        let dones = Array.from(new Set(this.doneList))
        console.log('--doneList--', dones);

        let date = new Date()
        downLoadCSV(this.noInsertList, `${platform_name}-${date.getTime()}- no insert list`)
      },

      async createRout(item, partner_id, parentFleetId, platform_name) {
        let { from_zone: fromZone, to_zone: toZone, from_detail_address, to_detail_address, from_place: fromPlace, to_place: toPlace, from_address: fromAddress, to_address: toAddress } = item
        let from_zone = fromZone || fromPlace
        let to_zone = toZone || toPlace
        if (!to_zone || !from_zone) {
          item['note'] = 'No from/to'
          this.noInsertList.push(item)
          return
        }
        from_zone = from_zone.trim()
        to_zone = to_zone.trim()

        console.log(`-----${i++}----${from_zone}--${to_zone}`);
        let from_address = from_detail_address || fromAddress || null
        let to_address = to_detail_address || toAddress || null


        if (!from_address || !to_address) {
          item['note'] = 'No detailed address'
          this.noInsertList.push(item)
          return
        }

        from_address = addressHandler(from_address)
        to_address = addressHandler(to_address)
        from_zone = addressHandler(from_zone)
        to_zone = addressHandler(to_zone)


        let airportInfoObj = await getAirport(from_zone, to_zone)
        let { code: airportSearchResCode } = airportInfoObj
        if (airportSearchResCode > 0) {
          if (airportSearchResCode == 1) {
            item['note'] = 'No  airport'
          } else {
            item['note'] = 'From and to are both airports'
          }
          this.noInsertList.push(item)
          return
        }
        let { isPickup, airportInfo } = airportInfoObj
        let airportCode = isPickup ? from_zone : to_zone


        let str = `${parentFleetId}-${airportCode}`
        let fleetInfo = cache[str]
        if (!fleetInfo) {
          fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)
        }
        let { fleet_id, pricing, pricing_id } = fleetInfo

        debugger
        if (!fleet_id) {
          item['note'] = 'NO fleet'
          this.noInsertList.push(item)
          return
        }

        cache[str] = fleetInfo

        if (!pricing) {
          item['note'] = 'no pricing json'
          this.noInsertList.push(item)
          return
        }
        let pricingJson = JSON.parse(pricing)

        let jsonHandled = jsonHandler3(pricingJson, from_zone, to_zone, isPickup, airportInfo)
        let { adjJson, from_place_lat_lng, to_place_lat_lng, code } = jsonHandled

        let rawOffset = await timeZoneHandler(pricingJson, airportInfo)


        if (code > 0) {
          if (code == 2) {
            item['note'] = 'There is a crossover in the fixed price circle'
            this.noInsertList.push(item)
          } else {
            item['note'] = 'no Fixed Price Zone'
            this.noInsertList.push(item)
          }
          return
        }

        let elifefleet = await getFleetIdByAirport(url, airportCode, stage == 'PROD' ? 15 : 40)
        let disable_date = this.getDisableDate(pricingJson)
        let route = {
          from_place: from_zone,
          to_place: to_zone,
          service_area_id: fleet_id,

          json: JSON.stringify(adjJson),
          name: `${from_zone}-${to_zone}`,
          from_place_lat_lng: JSON.stringify(from_place_lat_lng),
          to_place_lat_lng: JSON.stringify(to_place_lat_lng),

          service_area_id_elife: elifefleet.fleet_id,
          from_address,
          to_address,

          strategy_id,
          batch,
          is_active,
          // tz: rawOffset,
          tz_id: rawOffset,
          crawl_state,
          disable_date,

          partner_id,
          platform_name,
          route_type
        }
        route = Object.assign({}, route)
        console.log(route);
        debugger
        return route
      },



      async addRouteHandle(item, parentFleetId, partner_id, platform_name, isCopy = false) {
        let route = await this.createRout(item, partner_id, parentFleetId, platform_name)
        debugger
        if (!route) return
        let { from_place, to_place } = route
        if (!from_place || !to_place) return
        let routeInfo = await getRoute(url, from_place, to_place, partner_id)

        let { id: routeId } = routeInfo
        let res = null
        if (!routeId) {
          res = await insertSppRouteV2(url, route)
          if (res) {
            let { lastId } = res
            routeId = lastId
          }
          this.newRouteIds.push(routeId)
        } else {
          route['id'] = routeId
          let { is_active, batch, strategy_id } = routeInfo
          if (is_active < 11) {
            route['is_active'] = 11
            route['batch'] = 0
            route['strategy_id'] = 1
          } else {
            route['strategy_id'] = strategy_id
            route['batch'] = batch
            route['is_active'] = is_active
          }
          route['cost'] = 1

          let d = {
            sql: 134679330,
            version: '4.079',
            ids: `${routeId}`,
          }
          d = Object.assign({}, d, route)
          res = await fetchData({
            url,
            method: 'POST',
            data: d
          })
          res['lastId'] = routeId
          this.existsIds.push(routeId)
        }
        this.doneList.push(item)
        return res
      },



      async addRoute() {

        let { parentFleetId, partner_id, platform_name } = getPatnerInfo(partnerId, stage)
        console.log(dList);
        debugger
        let i = 0
        for (let item of dList) {
          await this.addRouteHandle(item, parentFleetId, partner_id, platform_name)
        }
        console.log('--noInsertList--', this.noInsertList);
        console.log('--doneList--', this.doneList);
        console.log('--this.existsIds--', this.existsIds);
        console.log('--this.newRouteIds--', this.newRouteIds);



        let date = new Date()
        downLoadCSV(this.noInsertList, `${platform_name}-${date.getTime()}- no insert list`)
      },


      createBarriers() {
        let isCircle = false
        let barriers = []
        let barriersLatLng = [
          [20.596357940533963, -86.65671626151678],
          [20.615400331443954, -86.89830037115604],
          [20.35216745796691, -87.06232326664797],
          [20.22694429941017, -86.98857653844227]
        ]



        points = []
        for (let item of barriersLatLng) {
          points.push({
            lat: item[0],
            lng: item[1],
          })
        }

        let len = points.length
        for (let i = 0; i < len; i++) {
          let { lat: fromLat, lng: fromLng } = points[i]
          let j = i + 1

          let obj = {
            a_lat: fromLat,
            a_lng: fromLng,
            a_cross: 0,
          }

          let nextObj = points[j]
          if (nextObj) {
            let { lat: toLat, lng: toLng } = nextObj
            obj['b_lat'] = toLat
            obj['b_lng'] = toLng
            obj['b_cross'] = 0
          } else {
            if (isCircle) {
              barriers.push(Object.assign({}, obj, {
                b_lat: points[0].lat,
                b_lng: points[0].lng,
                b_cross: 0,
              }))
            }
            continue
          }
          barriers.push(obj)
        }
        console.log(barriers);
      },


      async updateStrategy() {
        let sql = {
          sql: 134679330,
          version: '2.3'
        }

        let strategy = {
          "id": 18,
          "name": "less1ToWin",
          "partner_id": 5,
          "description": "cityairporttaxis less than 1 hour before pickup time to win float C",
        }

        let d = {
          url,
          method: 'POST',
          data: Object.assign({}, sql, strategy)
        }

        let res = await fetchData(d)
      },

      async addTz() {
        let arr = []
        for (let item of dList) {
          console.log(`-------${i++}--------`);
          let { id, is_active, from_place_lat_lng } = item
          let fromPlaceJson = JSON.parse(from_place_lat_lng)
          let { lat, lng } = fromPlaceJson
          if (!lat || !lng) {
            arr.push(item)
            continue
          }
          let timezoneRes = await fetchData({
            url: `https://maps.googleapis.com/maps/api/timezone/json`,
            method: 'GET',
            data: {
              location: `${lat},${lng}`,
              timestamp: Math.floor(Date.now() / 1000),
              // key: `AIzaSyCaAk67K9PyOQ5yuejv1xZGc7KOuKLOAUs`
              key: `AIzaSyD9mzj4sfSNhPUOmfp605SpbSMmip6TtD4`
            }
          })
          let { timeZoneId } = timezoneRes
          if (!timeZoneId) {
            arr.push(item)
            continue
          }
          let d = {
            sql: 134679330,
            version: '4.052',
            is_active,
            tz_id: timeZoneId,
            ids: id,
          }
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })

          let num = res['Affected rows']

          if (num) {
            this.doneList.push(id)
          }

        }
        console.log(arr);
        console.log(this.doneList);
      },


      async addStrategy() {
        let sql = {
          sql: 134679330,
          version: '2.31',
          is_active: 1,
        }




        let strategy = {
          "name": "less1ToWinFloatC",
          // "id": 15,
          "partner_id": 2,
          "description": "booking less than 1 hour before pickup time to win float C",
          "rules": JSON.stringify([])
        }


        let d = {
          url,
          method: 'POST',
          data: Object.assign({}, sql, strategy)
        }

        let res = await fetchData(d)


      },
      async setMng() {

        for (let route of addMNG_12_26) {
          console.log(`-------${i++}----`);
          let { id: routeId, service_area_id } = route

          let mng = mngCach[service_area_id]
          if (!mng) {
            // let pricingJson = await getLastPricingJsonBySvcId(url, service_area_id)


            console.log(pricingJson);
            mng = pricingJson?.pricing?.meet_n_greet
            mngCach[service_area_id] = mng
          }

          if (mng == undefined) {
            route['note'] = 'there is no meet and greet in the service area'
            this.noInsertList.push(route)
            continue
          }

          let resCosts = await getCostProfit(url, routeId)
          let costs = resCosts.results || []

          for (let c of costs) {
            // let { vehicle_class_id } = c
            // let vehiclePercent = vcs.find(item => item.id == vehicle_class_id)
            // let pm = vehiclePercent?.percent || partnerMarkup
            // c['partner_markup'] = `${pm / 100}`
            // c['sla'] = '0'
            c['mng'] = `${mng}`
          }

          console.log(costs);
          let insertCostRes = await insertCost(url, costs)
        }
      },

      async getAddrList(keywords = 'SFO') {
        if (!keywords) {
          return []
        }
        let list = cache[keywords]
        if (list) {
          return list
        }

        let { boundLat, boundLng, sessionToken, boundRadius } = this.originLatLng

        let url = `https://388bivap71.execute-api.us-east-2.amazonaws.com/prod/maps/places/auto-comp`
        let d = {
          input_text: keywords,
          location: `${boundLat},${boundLng}`,
          radius: boundRadius
        }
        if (sessionToken) {
          d['session_token'] = sessionToken
        }
        let res = await fetchData({
          url,
          data: d,
          isShowLoading: false
        })
        if (!res) return
        let { session_token } = res
        this.originLatLng.sessionToken = session_token
        list = res.predictions.predictions

        cache[keywords] = list
        return list
      },
      async getDetailByPlaceId(id) {

        let obj = cache[id]
        if (!obj) {
          let url = `https://388bivap71.execute-api.us-east-2.amazonaws.com/prod/maps/places/id`
          let d = {
            google_place_id: id
          }

          let { place_detail } = await fetchData({ url, data: d, isShowLoading: false })
          let { status } = place_detail

          if (status == 'OK') {
            let { result: { formatted_address, name: localName, geometry: { location } } } = place_detail

            let val = `${localName} ${formatted_address}`
            if (formatted_address.startsWith(localName)) {
              val = formatted_address
            }
            // this.elm.value = val

            let { lat, lng, } = location
            let t = typeof lat === 'number' ? lat : lat()
            let g = typeof lng === 'number' ? lng : lng()

            this.originLatLng.boundLat = lat
            this.originLatLng.boundLng = lng

            obj = { lat: t, lng: g, name: val }
          }
        }
        return obj
      },

      async getPriceElife(fLat, fLng, tLat, tLng, demand_fleet_id, supply_fleet_id) {
        let url = `https://j1j495o5pk.execute-api.us-east-2.amazonaws.com/upncoming/ride-pricings?from_lat=${fLat}&from_lng=${fLng}&to_lat=${tLat}&to_lng=${tLng}&ses=Unrfxa1M0lDAR4ODnRXP5DKfaLTD0Oe6SOfN6FtkCTTIdGi0jB8rcoLk8fsiJSDVd3V9o6hOkzZLeJxp46fW1VpAp7FznwOcR8e6LiMoBBQne4g9PyHdP9pe34omovzH&currency=USD&demand_fleet_id=${demand_fleet_id}&supply_fleet_id=${supply_fleet_id}`
        let response = await fetch(url)
        let res = await response.json();
        let { fleets } = res
        if (!fleets.length) {
          return []
        }
        let list = fleets[0].vehicle_classes
        return list
      },

      async getCost(ids, version) {
        let d = {
          sql: 134679330,
          version: version,
        }
        if (ids) {
          d['route_id'] = ids
        }

        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })


        return res
      },

      async runSQL(params) {
        let d = {
          sql: 134679330
        }

        d = Object.assign(d, params)

        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })

        return res

      },

      // 判断是否为英文字母（大小写均可）
      isEnglishChar(char) {
        const code = char.charCodeAt(0);
        return (code >= 65 && code <= 90) || (code >= 97 && code <= 122);
      }
    },

    setup() {
      const activeName = ref('changePricingJson')
      const inputValueRouteIds = ref('');
      const form = ref({
        ids: '2157,2158,2159,2160,2161,2162,2163,2164,2165,2166,2167,2168,2169,2170,2171,2172,2173,2174,2175,2176',
        partnerId: '2',
      })



      const partnerIds = ref([
        {
          id: 2
        },
        {
          id: 3
        },
        {
          id: 5
        },
        {
          id: 4
        },
        {
          id: 2692
        },
        {
          id: 28
        },
        {
          id: 2621
        },
        {
          id: 2588
        }
      ])

      const originLatLng = ref({ //initial bound lat and lng is sfo's
        boundLat: 37.6213129,
        boundLng: -122.3789554,
        boundRadius: 200000
      })
      const changePricingJsonForm = ref({
        fromSvcId: 451,
        toSvcId: 88894,
        type: []
      })

      const splitOutFleetSupplyIds = [51488, 61654, 67743, 78568, 72105, 85191, 75362, 89496, 15]

      const changeCurrencyData = ref({
        fromCur: 'USD',
        toCur: 'EUR',
        svcId: '1039,51531,61831,67905,72444,75472,78647,85373,89677,1040,51746,62048,68087,72663,75688,78862,85588,89893,11395,51900,62206,68223,72816,75841,79015,85744,90049,1154,52179,62487,68474,73091,76115,79288,86016,90322,1041,51912,62218,68232,72827,75852,79026,85755,90060,1042,52357,62667,68633,73266,76290,79462,86191,90497,1043,52437,62748,68701,73345,76369,79541,86270,90576,623,52289,62599,68572,73200,76224,79396,86125,90431,1044,52554,62866,68795,73462,76487,79659,86388,90693,1045,52740,63053,68954,73639,76664,79838,86566,90871,1046,52756,63069,68963,73656,76681,79855,86583,90888,1153,51827,62132,68153,72743,75769,78944,85670,89975'
      })



      return {
        abc: 1,
        noInsertList: [],
        existsIds: [],
        doneList: [],
        newRouteIds: [],
        form,
        activeName,
        partnerIds,
        originLatLng,
        changeCurrencyData,
        changePricingJsonForm,
        splitOutFleetSupplyIds
      }
    },




  });





  app.use(ElementPlus);

  app.mount("#app");
</script>
</html>