<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link rel="stylesheet" href="./index.css">
  <link rel="stylesheet" href="./app.css">
  <script src="./vue.global.js"></script>
  <script src="./index.full.js"></script>
  <script src="../components.js"></script>
  <script src="./index.js"></script>
</head>
<body>
  <div id="app">
    <el-tabs v-model="activeName" class="demo-tabs" @tab-click="handleClick">
      <el-tab-pane label="copy routes" name="first">
        <el-form :model="form" label-width="auto" style="max-width: 600px">
          <el-form-item label="Route ids">
            <el-input v-model="form.ids" type="textarea" />
          </el-form-item>
          <el-form-item label="to partner">
            <el-select v-model="form.partnerId" placeholder="please select partner">
              <el-option v-for="(item,index) in partnerIds" :label="item.id" :value="item.id" />
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="copyRoute">copy routes to other partner</el-button>
            <!-- <el-button>Cancel</el-button> -->
          </el-form-item>
        </el-form>
      </el-tab-pane>
      <el-tab-pane label="addTz" name="second">
        <el-button class="btn" type="primary" @click="addTz">addTz</el-button>
      </el-tab-pane>
      <el-tab-pane label="changeSvcID" name="changeSvcID">
        <el-button class="btn" type="primary" @click="changeSvcID">changeSvcID</el-button>
      </el-tab-pane>
      <el-tab-pane label="change currency" name="change currency">
        <el-form :model="form" label-width="auto" style="max-width: 600px">
          <el-form-item label="Activity name">
            <el-input v-model="form.name" />
          </el-form-item>
        </el-form>
        <el-button class="btn" type="primary" @click="changeCurrency">changeCurrency</el-button>
      </el-tab-pane>
      <el-tab-pane label="checkRoutes" name="checkRoutes">
        <!-- <el-button class="btn" type="primary" @click="checkRoutes">checkRoutes</el-button> -->
        <el-button class="btn" type="primary" @click="translateVehicleMapping">translateVehicleMapping</el-button>
      </el-tab-pane>
      <el-tab-pane label="uploadRouteZoneName" name="uploadRouteZoneName">
        <div class="upload-route-zone-box">
          <textarea name="" id="" v-model="inputValueRouteIds"></textarea>
          <el-button class="btn" type="primary" @click="uploadRouteZoneName">uploadRouteZoneName</el-button>
        </div>
      </el-tab-pane>
      <el-tab-pane label="Task" name="fourth">
        <el-button class="btn" type="primary" @click="updateRoute">updateRoute</el-button>
        <el-button class="btn" type="primary" @click="addRoute">addRoute</el-button>
        <el-button class="btn" type="primary" @click="addRoutePrice">addRoutePrice</el-button>
        <el-button class="btn" type="primary" @click="createBarriers">createBarriers</el-button>
        <el-button class="btn" type="primary" @click="setMng">setMng</el-button>
        <el-button class="btn" type="primary" @click="setSpecialDate">setSpecialDate</el-button>
        <el-button class="btn" type="primary" @click="addStrategy">addStrategy</el-button>
        <el-button class="btn" type="primary" @click="updateStrategy">updateStrategy</el-button>
        <el-button class="btn" type="primary"
                   @click="addFleetToRideVehicleMapping">addFleetToRideVehicleMapping</el-button>
        <el-button class="btn" type="primary" @click="addRoutePriceAdj">addRoutePriceAdj</el-button>
        <el-button class="btn" type="primary" @click="syncCost">syncCost</el-button>
        <el-button class="btn" type="primary" @click="checkZonePolygon">checkZonePolygon</el-button>
        <el-button class="btn" type="primary" @click="addToYouXuan">addToYouXuan</el-button>
      </el-tab-pane>
    </el-tabs>
  </div>
</body>
<script src="./data/d_tem.js"></script>
<script setup>
  const { createApp, ref, reactive, computed, watch, defineComponent, onMounted } = Vue;
  const stage = 'PROD' //PROD,DEV
  const url = stage == 'PROD' ? urlProd : urlDev
  const crawl_state = '1'

  const is_active = 11
  const strategy_id = 1

  let i = 0
  let cache = {}
  let partnerJson = null


  const batch = 0
  const partnerId = 2692
  let dList = stage == 'PROD' ? data_4_10 : []



  const app = createApp({
    // components: { Parent },

    methods: {

      async translateVehicleMapping() {


        let ctripMapping = {}
        for (let item of vehicle_type_mapping) {
          let { countries, mapping } = item

          for (let c of countries) {
            let res = await this.runSQL({
              sql: 134678012,
              version: '1.3',
              country_code: `${c}`
            })
            let vehicles = res.results
            ctripMapping[`${c}`] = []
            for (let m of mapping) {
              let { elife: vid, china_ctrip_api } = m
              let curVehicle = vehicles.find(o => o.vehicle_id == vid)
              let { vehicle_name, o_max_passenger, o_maker, o_model, o_image_url, o_image_url_2, o_max_luggage, maker, model, max_passenger, max_luggage, image_url_1, image_url_2, maker_txt_id, model_txt_id } = curVehicle

              let partnerVehicle = x_ctrip.find(o => o["车型ID"] == china_ctrip_api)
              let pvName = 'xxxx'
              if (partnerVehicle) {
                pvName = partnerVehicle['车型名称']
              }
              debugger
              ctripMapping[`${c}`].push(
                // {
                //   "id": this.uuid(),
                //   "vehicle_class_id": vid,
                //   "vehicle_class": vehicle_name,
                //   "maker": maker ? maker : o_maker,
                //   "model": model ? model : o_model,
                //   "max_passengers": max_passenger ? max_passenger : o_max_passenger,
                //   "min_passengers": 1,
                //   "max_luggage": max_luggage ? max_luggage : o_max_luggage,
                //   "min_luggage": 1,
                //   "image_url_1": image_url_1 ? image_url_1 : o_image_url,
                //   "image_url_2": image_url_2 ? image_url_2 : o_image_url_2,
                //   "x_vehicle_class_id": '',
                //   "x_maker": "",
                //   "x_model": "",
                //   "x_max_luggage": "",
                //   "x_min_luggage": "",
                //   "x_vehicle_class": "",
                //   "x_max_passengers": "",
                //   "x_min_passengers": "",
                //   "x_vehicle_category": "", // only mozio
                //   "x_vehicle_class" : pvName
                // },
                {
                  "id": this.uuid(),
                  "vehicle_class_id": vid,
                  "vehicle_class": vehicle_name,
                  "maker": "",
                  "model": "",
                  "max_passengers": "",
                  "min_passengers": "",
                  "max_luggage": "",
                  "min_luggage": "",
                  "image_url_1": "",
                  "image_url_2": "",
                  "x_vehicle_class_id": '',
                  "x_maker": "",
                  "x_model": "",
                  "x_max_luggage": "",
                  "x_min_luggage": "",
                  "x_vehicle_class": "",
                  "x_max_passengers": "",
                  "x_min_passengers": "",
                  "x_vehicle_category": "", // only mozio
                  "x_vehicle_class": pvName
                }
              )
            }
          }
        }



        console.log(JSON.stringify(ctripMapping));


      },

      uuid() {
        function S4() {
          return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1)
        }
        return S4() + '-' + S4() + '-' + S4()
      },

      async uploadRouteZoneName() {
        let ids = this.inputValueRouteIds
        if (!ids) return
        let d = {
          "sql": 134679330,
          "version": "4.061",
          ids
        }
        let routes = await this.runSQL(d)

        for (let item of routes.results) {
          let { id, from_place, to_place, partner_id } = item
          let { parentFleetId, platform_name } = getPatnerInfo(partner_id, stage)
          debugger
          await this.addRouteHandle(item, parentFleetId, partner_id, platform_name)
        }

        console.log('--noInsertList--', this.noInsertList);
        console.log('--doneList--', this.doneList);
        console.log('--this.existsIds--', this.existsIds);
        console.log('--this.newRouteIds--', this.newRouteIds);



        let date = new Date()
        downLoadCSV(this.noInsertList, `${date.getTime()}- no insert list`)


      },

      async addToYouXuan() {
        for (let id of ids) {
          let d = {
            sql: 134679330,
            version: '4.062',
            route_id: id,
            pre_percent: 0.1
          }

          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })

          debugger

        }




      },

      async checkZonePolygon() {
        let { parentFleetId, partner_id, platform_name } = getPatnerInfo(partnerId, stage)
        debugger
        for (let item of dList) {
          let { id, name, service_area_pricing_id } = item
          console.log(`-----${i++}-----------`, id, '---', name, this.noInsertList);


          let pricingJson = await getPricingJsonBySvcId(url, id)
          if (!service_area_pricing_id) {
            pricingJson = await getLastPricingJsonBySvcId(url, id)
          }

          if (!pricingJson) {
            console.log('--------continue---------');
            continue
          }

          let { zones } = pricingJson
          if (!zones) continue

          for (let z of zones) {
            let { polygons } = z
            if (!polygons) continue
            let flag = hasSelfIntersect(polygons)
            if (flag) {
              this.noInsertList.push({
                id,
                "service area": name,
                zone_name: z.name,
                note: 'zone has self intersect'
              })
            }
          }
        }

        let date = new Date()
        downLoadCSV(this.noInsertList, `${platform_name}-${date.getTime()}- zone has self intersect`)

      },

      async syncCost() {

        let d = {
          "version": "4.053",
          "countries": `"ABW","TUR"`
        }

        let aa = await this.runSQL(d)


        debugger
        console.log(dList);

        for (let item of dList) {
          let { from_place, to_place, id } = item
          let str = `${from_place}-${to_place}`
          let num = cache[str]
          if (num) continue
          cache[str] = 1
          let ids = dList.filter(obj => obj.from_place == from_place && obj.to_place == to_place).map(o => o.id)
          let { results: allVehicleCost } = await this.getCost(ids.join(','), '4.015')
          for (let id of ids) {
            console.log(`----------${i++}--${id}--`);

            let res = await this.getCost(`${id}`, '4.015')
            let costs = res.results || []
            for (let c of costs) {
              let vc = allVehicleCost.find(item => item.vehicle_class_id == c.vehicle_class_id)
              c['cost'] = vc['cost']
            }
            console.log(costs);
            let insertCostRes = await insertCost(url, costs)
          }
        }
      },


      async checkRoutes() {
        console.log(dList);

        for (let item of dList) {
          console.log(`-------${i++}------`);
          let { from_place, to_place, from_address, to_address, partner_id } = item

          if (from_address.length == 3) {
            from_address = `${from_address} Airport`
          }
          if (to_address.length == 3) {
            to_address = `${to_address} Airport`
          }

          let fromList = await this.getAddrList(from_address)

          if (!fromList.length) {
            let obj = JSON.parse(JSON.stringify(item))
            obj['note'] = 'can not get from address info'
            this.noInsertList.push(obj)
            continue
          }

          let { place_id: from_place_id } = fromList[0]
          let fromDetail = await this.getDetailByPlaceId(from_place_id)

          let toList = await this.getAddrList(to_address)
          if (!toList.length) {
            let obj = JSON.parse(JSON.stringify(item))
            obj['note'] = 'can not get from address info'
            this.noInsertList.push(obj)
            continue
          }
          let to_place_id = toList[0].place_id
          let toDetail = await this.getDetailByPlaceId(to_place_id)

          let { lat: fLat, lng: fLng } = fromDetail
          let { lat: tLat, lng: tLng } = toDetail

          let { demand_fleet_id, supply_fleet_id } = getPatnerInfo(partner_id, stage)
          let res = await this.getPriceElife(fLat, fLng, tLat, tLng, demand_fleet_id, supply_fleet_id)
          let vehiclePrice = res[0]
          let { from, to, from_type, to_type } = vehiclePrice?.price_detail?.base_pricing?.fix_price_detail || {}
          if (from != from_place || to != to_place) {
            let obj = JSON.parse(JSON.stringify(item))
            obj['note'] = 'fixed price zone not match'
            this.noInsertList.push(obj)
            continue
          }

          this.doneList.push(item)
        }

        let date = new Date()
        downLoadCSV(this.noInsertList, `${date.toLocaleString()}- no insert list`)
        downLoadCSV(this.doneList, `${date.toLocaleString()}- doneList list`)
      },



      async addRoutePriceAdj() {
        let vehicles = getVehicles()
        let cStr = ' Cost'
        let pStr = ' min profit'
        let mStr = ' Max'



        for (let item of dList) {
          console.log(`-------${i++}--------`)

          let { id: routeId, from_zone: fz, to_zone: tz, service_area_id, from_place, to_place, partner_id } = item
          let { parentFleetId, partnerInfo } = getPatnerInfo(partner_id, stage)

          let from_zone = fz ? fz : from_place
          let to_zone = tz ? tz : to_place

          let airportInfoObj = await getAirport(from_zone, to_zone)
          if (!airportInfoObj) {
            item['note'] = 'No  airport'
            this.noInsertList.push(item)
            continue
          }
          let { isPickup, airportInfo } = airportInfoObj
          let airportCode = isPickup ? from_zone : to_zone

          let str = `${parentFleetId}-${airportCode}`
          let fleetInfo = cache[str]
          if (!fleetInfo) {
            fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)
          }

          let { fleet_id, pricing, pricing_id } = fleetInfo
          if (!fleet_id) {
            let obj = JSON.parse(JSON.stringify(item))
            obj['note'] = 'NO fleet'
            this.noInsertList.push(obj)
            continue
          }

          cache[str] = fleetInfo

          let pricingJson = JSON.parse(pricing)
          let prices = []
          for (let v of vehicles) {
            let vid = vehicleList.find(vehicle => vehicle.vehicle_name == v).vehicle_id


            let jsonHandled = await jsonHandler3(pricingJson, from_zone, to_zone, isPickup, airportInfo, vid)

            let { adjJson, from_place_lat_lng, to_place_lat_lng, code, tz } = jsonHandled
            if (code > 0) {
              if (code == 2) {
                item['note'] = 'There is a crossover in the fixed price circle'
                this.noInsertList.push(item)
              } else {
                item['note'] = 'no Fixed Price Zone'
                this.noInsertList.push(item)
              }
              continue
            }
            let { pAmt } = jsonHandled
            if (!pAmt) {
              let obj = JSON.parse(JSON.stringify(item))
              obj['note'] = 'no price adj'
              obj['vehicle_id'] = vid
              this.noInsertList.push(obj)
              continue
            }
            console.log('--', routeId, '--', v, '--', vid, '---', pAmt);
            prices.push({
              route_id: routeId,
              vehicle_class_id: vid,
              price: pAmt
            })
            this.doneList.push(routeId)
          }
          let insertAdjRes = await insertAdj(url, prices)
        }


        console.log('--this.noInsertList--', this.noInsertList);
        let dones = Array.from(new Set(this.doneList))
        console.log('--doneList--', dones);

        let date = new Date()
        downLoadCSV(this.noInsertList, `${date.toLocaleString()}- no insert list`)
      },

      async addFleetToRideVehicleMapping() {

        let d = {
          sql: 134679330,
          version: '4.049',
          vehicle_ids: [36, 1, 2, 3, 4, 6, 40, 41, 12, 13, 14, 7, 43, 42, 48, 49, 52, 100, 5, 102, 103, 101, 104, 105, 106, 108],
          to_vehicle_id: 109
        }
        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })

      },

      async changeCurrency() {

        let svcList = []
        // let partnerIds = [15,3, 2690, 2621, 2692, 5, 4, 28, 2, 1000]
        let partnerIds = [15]
        console.log(svcList);

        for (let pid of partnerIds) {

          // let { parentFleetId } = getPatnerInfo(pid, stage)
          let parentFleetId = 15
          for (let svc of svcList) {
            console.log(`--${i++}---`)
            let { name } = svc

            let { id: fleetId } = await getFleetByName(url, name, parentFleetId)
            if (!fleetId) {
              this.noInsertList.push({
                partnerId: pid,
                name,
                note: 'do not find service area'
              })
              continue
            }

            // let pricingJson = await getLastPricingJsonBySvcId(url, fleetId)
            if (!pricingJson) {
              this.noInsertList.push({
                partnerId: pid,
                name,
                note: 'do not have service area pricing'
              })
              continue
            }

            console.log('--befor--', pricingJson);


            let fromCur = pricingJson.currencyCode

            if (fromCur == 'USD') {
              this.noInsertList.push({
                partnerId: pid,
                name,
                note: 'the currency is already USD'
              })
              continue
            }
            let toCur = 'USD'
            let rate = await getCurrencyRates(fromCur, toCur)

            const targetFields = ["min_amount", "amount", 'delta_amount', 'meet_n_greet', "p_amt", "d_amt"];


            let changedJson = this.updateFields(JSON.parse(JSON.stringify(pricingJson)), targetFields, rate, toCur)
            changedJson['currencyCode'] = toCur
            console.log('----changed---', changedJson);

            let pricingStr = JSON.stringify(changedJson)
            let res = await insertAndUpdate(url, pricingStr, fleetId)
            if (!res) {
              this.noInsertList.push({
                partnerId: pid,
                name,
                note: 'Insert error'
              })
            } else {
              this.doneList.push({
                partnerId: pid,
                name,
              })
            }
          }
        }

        let date = new Date()
        downLoadCSV(this.noInsertList, `no insert list`)
        downLoadCSV(this.doneList, `doneList`)
      },




      updateFields(obj, targetFields, rate, currencyCode) {
        if (typeof obj === "object" && obj !== null) {
          for (let key in obj) {
            if (key == 'currency') {
              obj[key] = currencyCode
            }
            if (targetFields.includes(key) && typeof obj[key] === "number") {
              obj[key] = Number((Number(obj[key]) * rate).toFixed(2));
            } else if (typeof obj[key] === "object") {
              this.updateFields(obj[key], targetFields, rate, currencyCode);
            }
          }
        }
        return obj
      },

      async changeSvcID() {
        let { partnerInfo, parentFleetId } = getPatnerInfo(partnerId, stage)
        for (let r of dList) {
          console.log(`-----${i++}----`);
          let { id, from_place, to_place } = r
          let airportInfoObj = await getAirport(from_place, to_place)
          let { code: airportSearchResCode } = airportInfoObj
          if (airportSearchResCode > 0) {
            if (airportSearchResCode == 1) {
              item['note'] = 'No  airport'
            } else {
              item['note'] = 'From and to are both airports'
            }
            this.noInsertList.push(item)
            continue
          }
          let { isPickup, airportInfo } = airportInfoObj
          let airportCode = isPickup ? from_place : to_place

          let str = `${parentFleetId}-${airportCode}`
          let fleetInfo = cache[str]
          if (!fleetInfo) {
            fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)

          }
          let { fleet_id, pricing, pricing_id } = fleetInfo
          if (!fleet_id) {
            item['note'] = 'NO fleet'
            this.noInsertList.push(item)
            continue
          }

          cache[str] = fleetInfo

          let d = {
            sql: 134679330,
            version: '4.045',
            is_active: '99',
            service_area_id: fleet_id,
            ids: `${id}`,
          }
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })

          let num = res['Affected rows']
          if (num != 1) {
            item['note'] = 'inser error'
            this.noInsertList.push(item)
          }

        }

        console.log('--noInsertList--', this.noInsertList);
        console.log('--doneList--', this.doneList);
        console.log('--this.existsIds--', this.existsIds);
        console.log('--this.newRouteIds--', this.newRouteIds);



        let date = new Date()
        downLoadCSV(this.noInsertList, `${parentFleetId}-${date.toLocaleString()}- no insert list`)

      },
      handleClick(tab, event) {
        console.log(tab, event)
      },



      getDisableDate(pricingJson) {
        let specialCharge = pricingJson?.specific_date_surcharge || []
        let arr = []
        for (let item of specialCharge) {
          let { from_date, to_date } = item
          if (!from_date || !to_date) continue
          arr.push(`${from_date}/${to_date}`)
        }
        let dateStr = arr.join(',')
        return dateStr
      },

      async setSpecialDate() {
        for (let route of dList) {
          console.log(`------${i++}-----`);

          let { id, service_area_id } = route
          debugger
          let dateStr = cache[service_area_id]
          if (!dateStr) {
            // let pricingJson = await getLastPricingJsonBySvcId(url, service_area_id)
            let specialCharge = pricingJson?.specific_date_surcharge || []
            let arr = []
            for (let item of specialCharge) {
              let { from_date, to_date } = item
              if (!from_date || !to_date) continue
              arr.push(`${from_date}/${to_date}`)
            }
            dateStr = arr.join(',')
            cache[service_area_id] = dateStr
          }

          let d = {
            sql: 134679330,
            version: '4.045',
            is_active: '99',
            disable_date: dateStr,
            ids: `${id}`,
          }
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })
        }
      },

      async updateRoute() {
        let ids = [
          5137, 5139
        ]
        console.log(ids);

        let idsStr = ids.join(',')

        let url = urlProd   // urlDev,urlProd
        let d = {
          sql: 134679330,
          version: '4.045',
          is_active: '99',
          // tz,
          // batch: '24',
          // strategy_id: 1,
          // crawl_state:'0',
          // platform_name:'m.ctrip.com',
          // from_address: this.addressHandler(start_place_address),
          // to_address: addressHandler(add),
          from_place: "千叶",
          // "json": '{"d_amt":"zones.1.prices.0.d_amt"}',
          // "to_place":"千叶",
          ids: idsStr,
        }
        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })
        return res
      },


      async copyRoute() {
        let { ids, partnerId } = this.form
        if (!partnerId || !ids) return
        let idsArr = ids.split(',')
        console.log(idsArr, partnerId);
        let { partnerInfo, parentFleetId } = getPatnerInfo(partnerId, stage)
        for (let id of idsArr) {
          console.log(`----------${i++}----------`);
          let item = await getRouteById(url, id)

          let originalRouteId = item.id
          delete item.id
          let { from_place,
            to_place,
            service_area_id,
            from_address,
            to_address, service_area_id_elife } = item

          let airportInfoObj = await getAirport(from_place, to_place)
          let { code: airportSearchResCode } = airportInfoObj
          if (airportSearchResCode > 0) {
            if (airportSearchResCode == 1) {
              item['note'] = 'No  airport'
            } else {
              item['note'] = 'From and to are both airports'
            }
            this.noInsertList.push(item)
            continue
          }
          let { isPickup, airportInfo } = airportInfoObj
          let airportCode = isPickup ? from_place : to_place
          let { fleet_id, pricing } = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)

          let pricingJson = JSON.parse(pricing)
          let jsonHandled = await jsonHandler3(pricingJson, from_place, to_place, isPickup, airportInfo)
          let { adjJson, from_place_lat_lng, to_place_lat_lng, code, tz } = jsonHandled



          if (code > 0) {
            if (code == 2) {
              item['note'] = 'There is a crossover in the fixed price circle'
              this.noInsertList.push(item)
            } else {
              item['note'] = 'no Fixed Price Zone'
              this.noInsertList.push(item)
            }
            continue
          }


          let route_info = {
            service_area_id: fleet_id,
            strategy_id: 1,
            batch,
            is_active,
            crawl_state,
            tz,
            json: JSON.stringify(adjJson),
            from_place_lat_lng: JSON.stringify(from_place_lat_lng),
            to_place_lat_lng: JSON.stringify(to_place_lat_lng),
            name: `${from_place}-${to_place}`
          }

          let route = Object.assign({}, item, route_info, partnerInfo)
          route['service_area_id'] = fleet_id
          console.log(route);

          let routeInfo = await getRoute(url, from_place, to_place, partnerId)
          let { id: routeId } = routeInfo
          if (!routeId) {
            let res = await insertSppRouteV2(url, route)
            let { lastId } = res
            routeId = lastId
          }


          this.newRouteIds.push(routeId)
          let originalCost = await getCostProfit(url, originalRouteId)
          let costs = []
          let prices = []
          for (let c of originalCost.results) {
            c['route_id'] = routeId
            costs.push(c)
            let { vehicle_class_id } = c
            let jsonHandled = await jsonHandler3(pricingJson, from_place, to_place, isPickup, airportInfo, vehicle_class_id)
            let { pAmt } = jsonHandled
            if (!pAmt) continue
            prices.push({
              price: pAmt,
              route_id: routeId,
              vehicle_class_id
            })
          }
          console.log(prices);
          console.log(costs);
          let insertCostRes = await insertCost(url, costs)
          let insertAdjRes = await insertAdj(url, prices)
        }

        this.form = {
          ids: '',
          partnerId: '',
        }

        let date = new Date()
        downLoadCSV(this.noInsertList, `${parentFleetId}-${date.toLocaleString()}- no insert list`)
      },




      async addRoutePrice() {
        let vehicles = getVehicles()
        let cStr = ' Cost'
        let pStr = ' min profit'
        let mStr = ' Max'
        let { parentFleetId, platform_name } = getPatnerInfo(partnerId, stage)
        console.log(dList);

        debugger
        let i = 0
        for (let item of dList) {
          console.log(`-------${i++}--------`);
          let { from_zone: fz, to_zone: tz, service_area_id, from_place, to_place } = item

          let from_zone = fz ? fz : from_place
          let to_zone = tz ? tz : to_place

          debugger
          if (!from_zone || !to_zone) {
            this.noInsertList.push(item)
            continue
          }

          let { id: routeId } = await getRoute(url, from_zone, to_zone, partnerId)

          if (!routeId) {
            item['note'] = 'no route'
            this.noInsertList.push(item)
            continue
          }

          let airportInfoObj = await getAirport(from_zone, to_zone)
          if (!airportInfoObj) {
            item['note'] = 'No  airport'
            this.noInsertList.push(item)
            continue
          }
          let { isPickup, airportInfo } = airportInfoObj
          let airportCode = isPickup ? from_zone : to_zone

          let str = `${parentFleetId}-${airportCode}`
          let fleetInfo = cache[str]
          if (!fleetInfo) {
            fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)
          }

          let { fleet_id, pricing, pricing_id } = fleetInfo
          if (!fleet_id) {
            item['note'] = 'NO fleet'
            this.noInsertList.push(item)
            continue
          }
          cache[str] = fleetInfo

          let routeStr = `route-${from_zone}-${to_zone}`

          let sameRoutes = cache[routeStr]
          if (!sameRoutes) {
            let res = await this.runSQL({
              version: '1.10',
              from_place: from_zone,
              to_place: to_zone
            })
            sameRoutes = res?.results || []
          }

          let costStr = `cost-${from_zone}-${to_zone}`
          let sameCosts = cache[costStr] || []
          if (sameRoutes.length && sameCosts.length == 0) {
            let ids = []
            for (let r of sameRoutes) {
              ids.push(r.route_id)
            }
            let res = await this.runSQL({
              version: '4.015',
              route_id: ids.join(','),
            })
            sameCosts = res.results
          }


          let pricingJson = JSON.parse(pricing)
          let costs = []
          let prices = []
          for (let vehicleInfo of vehicles) {
            let { name: v, id } = vehicleInfo

            let cost = sameCosts.find(sc => sc.vehicle_class_id == id)?.cost
            debugger
            if (!cost) {
              cost = Number(item[`${v}${cStr}`].replace(/\$/g, '').replace(/\,/g, '')) || 1000
            }

            if (!cost) {
              item['note'] = 'no cost'
              this.noInsertList.push(item)
              continue
            }

            let profit = item[`${v}${pStr}`]
            let max = item[`${v}${mStr}`]


            if (!profit) {
              profit = '0'
            }
            profit = Number(profit.replace(/\%/g, '')) / 100
            if (!profit) {
              profit = '0'
            }
            if (max) {
              max = Number(max.replace(/\$/g, ''))
            }


            let vid = vehicleList.find(vehicle => vehicle.vehicle_name == v).vehicle_id

            let jsonHandled = await jsonHandler3(pricingJson, from_zone, to_zone, isPickup, airportInfo, vid)
            if (!jsonHandled) {
              item['note'] = 'no Fixed Price Zone'
              this.noInsertList.push(item)
              continue
            }
            let { pAmt } = jsonHandled
            console.log('--', routeId, '--', v, '--', vid, '----', cost, '---', profit, '--', max, '---', pAmt);
            if (pAmt && cost) {
              let obj = {
                route_id: routeId,
                vehicle_class_id: vid,
                cost,
                profit
              }

              if (max) {
                obj['max'] = max
              }
              prices.push({
                route_id: routeId,
                vehicle_class_id: vid,
                price: pAmt
              })

              costs.push({
                route_id: routeId,
                vehicle_class_id: vid,
                cost,
                profit
              })
            }
            this.doneList.push(routeId)
          }

          debugger
          let insertCostRes = await insertCost(url, costs)
          let insertAdjRes = await insertAdj(url, prices)
        }

        console.log('--this.noInsertList--', this.noInsertList);
        let dones = Array.from(new Set(this.doneList))
        console.log('--doneList--', dones);

        let date = new Date()
        downLoadCSV(this.noInsertList, `${platform_name}-${date.getTime()}- no insert list`)
      },





      async addRouteHandle(item, parentFleetId, partner_id, platform_name) {
        let { from_zone: fromZone, to_zone: toZone, from_detail_address, to_detail_address, from_place: fromPlace, to_place: toPlace, from_address: fromAddress, to_address: toAddress } = item

        debugger
        let from_zone = fromZone || fromPlace
        let to_zone = toZone || toPlace
        if (!to_zone || !from_zone) {
          item['note'] = 'No from/to'
          this.noInsertList.push(item)
          return
        }
        from_zone = from_zone.trim()
        to_zone = to_zone.trim()

        console.log(`-----${i++}----${from_zone}--${to_zone}`);
        let from_address = from_detail_address || fromAddress || null
        let to_address = to_detail_address || toAddress || null


        if (!from_address || !to_address) {
          item['note'] = 'No detailed address'
          this.noInsertList.push(item)
          return
        }

        from_address = addressHandler(from_address)
        to_address = addressHandler(to_address)
        from_zone = addressHandler(from_zone)
        to_zone = addressHandler(to_zone)


        let airportInfoObj = await getAirport(from_zone, to_zone)
        let { code: airportSearchResCode } = airportInfoObj
        if (airportSearchResCode > 0) {
          if (airportSearchResCode == 1) {
            item['note'] = 'No  airport'
          } else {
            item['note'] = 'From and to are both airports'
          }
          this.noInsertList.push(item)
          return
        }
        let { isPickup, airportInfo } = airportInfoObj
        let airportCode = isPickup ? from_zone : to_zone


        let str = `${parentFleetId}-${airportCode}`
        let fleetInfo = cache[str]
        if (!fleetInfo) {
          fleetInfo = await getFleetIdAndPricingByAirport(url, airportCode, parentFleetId)
        }
        let { fleet_id, pricing, pricing_id } = fleetInfo
        if (!fleet_id) {
          item['note'] = 'NO fleet'
          this.noInsertList.push(item)
          return
        }

        cache[str] = fleetInfo

        if (!pricing) {
          item['note'] = 'no pricing json'
          this.noInsertList.push(item)
          return
        }
        let pricingJson = JSON.parse(pricing)

        let jsonHandled = await jsonHandler3(pricingJson, from_zone, to_zone, isPickup, airportInfo)
        let { adjJson, from_place_lat_lng, to_place_lat_lng, code } = jsonHandled

        let rawOffset = await timeZoneHandler(pricing, airportInfo)


        if (code > 0) {
          if (code == 2) {
            item['note'] = 'There is a crossover in the fixed price circle'
            this.noInsertList.push(item)
          } else {
            item['note'] = 'no Fixed Price Zone'
            this.noInsertList.push(item)
          }
          return
        }

        let routeInfo = await getRoute(url, from_zone, to_zone, partner_id)
        let { id: routeId } = routeInfo

        let elifefleet = await getFleetIdByAirport(url, airportCode, stage == 'PROD' ? 15 : 40)

        let disable_date = this.getDisableDate(pricingJson)

        let route = {
          from_place: from_zone,
          to_place: to_zone,
          service_area_id: fleet_id,

          json: JSON.stringify(adjJson),
          name: `${from_zone}-${to_zone}`,
          from_place_lat_lng: JSON.stringify(from_place_lat_lng),
          to_place_lat_lng: JSON.stringify(to_place_lat_lng),



          service_area_id_elife: elifefleet.fleet_id,
          from_address,
          to_address,

          strategy_id,
          batch,
          is_active,
          // tz: rawOffset,
          tz_id: rawOffset,
          crawl_state,
          disable_date,

          partner_id,
          platform_name
        }


        route = Object.assign({}, route)
        console.log(route);
        debugger
        if (!routeId) {
          let res = await insertSppRouteV2(url, route)
          if (res) {
            let { lastId } = res
            routeId = lastId
          }
          this.newRouteIds.push(routeId)
        } else {
          route['id'] = routeId
          let { is_active, batch, strategy_id } = routeInfo
          if (is_active < 11) {
            route['is_active'] = 11
            route['batch'] = 0
            route['strategy_id'] = 1
          } else {
            route['strategy_id'] = strategy_id
            route['batch'] = batch
            route['is_active'] = is_active
          }
          let d = {
            sql: 134679330,
            version: '4.052',
            ids: `${routeId}`,
          }
          d = Object.assign({}, d, route)
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })

          this.existsIds.push(routeId)
        }
        this.doneList.push(item)
      },



      async addRoute() {
        let { parentFleetId, partner_id, platform_name } = getPatnerInfo(partnerId, stage)
        console.log(dList);
        let i = 0
        debugger

        for (let item of dList) {
          await this.addRouteHandle(item, parentFleetId, partner_id, platform_name)
        }
        console.log('--noInsertList--', this.noInsertList);
        console.log('--doneList--', this.doneList);
        console.log('--this.existsIds--', this.existsIds);
        console.log('--this.newRouteIds--', this.newRouteIds);



        let date = new Date()
        downLoadCSV(this.noInsertList, `${platform_name}-${date.getTime()}- no insert list`)
      },


      createBarriers() {
        let isCircle = false
        let barriers = []
        let barriersLatLng = [
          [20.596357940533963, -86.65671626151678],
          [20.615400331443954, -86.89830037115604],
          [20.35216745796691, -87.06232326664797],
          [20.22694429941017, -86.98857653844227]
        ]



        points = []
        for (let item of barriersLatLng) {
          points.push({
            lat: item[0],
            lng: item[1],
          })
        }

        let len = points.length
        for (let i = 0; i < len; i++) {
          let { lat: fromLat, lng: fromLng } = points[i]
          let j = i + 1

          let obj = {
            a_lat: fromLat,
            a_lng: fromLng,
            a_cross: 0,
          }

          let nextObj = points[j]
          if (nextObj) {
            let { lat: toLat, lng: toLng } = nextObj
            obj['b_lat'] = toLat
            obj['b_lng'] = toLng
            obj['b_cross'] = 0
          } else {
            if (isCircle) {
              barriers.push(Object.assign({}, obj, {
                b_lat: points[0].lat,
                b_lng: points[0].lng,
                b_cross: 0,
              }))
            }
            continue
          }
          barriers.push(obj)
        }
        console.log(barriers);
      },


      async updateStrategy() {
        let sql = {
          sql: 134679330,
          version: '2.3'
        }

        let strategy = {
          "id": 15,
          "name": "HF_V2",
        }

        let d = {
          url,
          method: 'POST',
          data: Object.assign({}, sql, strategy)
        }

        let res = await fetchData(d)
      },

      async addTz() {
        for (let item of dList) {
          let { id, service_area_id, is_active } = item
          debugger
          let pricing = await getPricingJsonBySvcId(url, service_area_id)
          let tz = await timeZoneHandler(pricing)

          debugger
          let d = {
            sql: 134679330,
            version: '4.052',
            is_active: 99,
            tz_id: tz,
            ids: id,
          }
          let res = await fetchData({
            url,
            method: 'POST',
            data: d
          })
        }
      },


      async addStrategy() {
        let sql = {
          sql: 134679330,
          version: '2.31',
          is_active: 1
        }




        let strategy = {
          "name": "(HF)less1ToWin V2",
          // "id": 15,
          "partner_id": 2,
          "description": "booking High-freq V2, less1 to win",
          "rules": JSON.stringify([
            {
              "name": "rule-1-1",
              "description": "Elife is_lowest and the adjusted-price is in low profit zone for the first-time ",
              "conditions": ["is_lowest", "adjusted_price_in_low_profit_zone", "continuous_low_profit_count_is_null"],
              "action": "set_init_low_profit_zone_entry_count"
            },
            {
              "name": "rule-1-2",
              "description": "Elife is_lowest and the adjusted-price is in low profit zone and continuous_low_profit_count_is_gt_1",
              "conditions": ["is_lowest", "adjusted_price_in_low_profit_zone", "continuous_low_profit_count_is_gt_1"],
              "action": "decrease_continuous_low_profit_count"
            },
            {
              "name": "rule-1-3",
              "description": "Elife is_lowest and the adjusted-price is in low profit zone and continuous_low_profit_count_is_1",
              "conditions": ["is_lowest", "adjusted_price_in_low_profit_zone", "continuous_low_profit_count_is_1"],
              "action": "increase_price_to_1_5x_min_price"
            },
            {
              "name": "rule-2",
              "description": "Elife is_lowest and the adjusted-price is in high profit zone and continuous_low_profit_count_is_1",
              "conditions": ["is_lowest", "adjusted_price_in_high_profit_zone", "continuous_low_profit_count_is_1"],
              "action": "set_continuous_low_profit_count_to_null"
            },
            {
              "name": "rule-3",
              "description": "Elife is_lowest and the adjusted-price is lower than cost",
              "conditions": ["is_lowest", "adjusted_price_is_lower_than_cost"],
              "action": "set_price_to_cost"
            },
            {
              "name": "rule-4",
              "description": "Elife is_lowest and the continuous_elife_count is 24",
              "conditions": ["is_lowest", "continuous_elife_count_is_24"],
              "action": "increase_price_to_1_5x_min_price"
            },
            {
              "name": "rule-5.1",
              "description": "Elife is_not_lowest and the adjusted-price is in high profit zone and continuous_low_profit_count_is_null",
              "conditions": ["is_not_lowest", "adjusted_price_in_high_profit_zone", "continuous_low_profit_count_is_null"],
              "action": "match_first_price"
            },
            {
              "name": "rule-5.2",
              "description": "Elife is_not_lowest and the adjusted-price is in high profit zone and continuous_low_profit_count_is_1",
              "conditions": ["is_not_lowest", "adjusted_price_in_high_profit_zone", "continuous_low_profit_count_is_1"],
              "action": "match_first_price_and_set_continuous_low_profit_count_to_null"
            },
            {
              "name": "rule-6",
              "description": "Elife is_not_lowest and the adjusted-price is in low profit zone and continuous_low_profit_count_is_null",
              "conditions": ["is_not_lowest", "adjusted_price_in_low_profit_zone", "continuous_low_profit_count_is_null"],
              "action": "match_first_price_and_set_init_entry_count"
            },
            {
              "name": "rule-7",
              "description": "Elife is_not_lowest and the adjusted-price is in low profit zone and entry_count_is_gt1",
              "conditions": ["is_not_lowest", "adjusted_price_in_low_profit_zone", "continuous_low_profit_count_is_gt_1"],
              "action": "match_first_price_and_decrease_continuous_low_profit_count"
            },
            {
              "name": "rule-8",
              "description": "Elife is_not_lowest and the adjusted-price is in low profit zone and continuous_low_profit_count_is_1",
              "conditions": ["is_not_lowest", "adjusted_price_in_low_profit_zone", "continuous_low_profit_count_is_1"],
              "action": "do_nothing"
            },
            {
              "name": "rule-9",
              "description": "Elife is_not_lowest and the adjusted-price is lower than cost",
              "conditions": ["is_not_lowest", "adjusted_price_is_lower_than_cost"],
              "action": "set_price_to_cost"
            }
          ])
        }


        let d = {
          url,
          method: 'POST',
          data: Object.assign({}, sql, strategy)
        }

        let res = await fetchData(d)


      },
      async setMng() {

        for (let route of addMNG_12_26) {
          console.log(`-------${i++}----`);
          let { id: routeId, service_area_id } = route

          let mng = mngCach[service_area_id]
          if (!mng) {
            // let pricingJson = await getLastPricingJsonBySvcId(url, service_area_id)


            console.log(pricingJson);
            mng = pricingJson?.pricing?.meet_n_greet
            mngCach[service_area_id] = mng
          }

          if (mng == undefined) {
            route['note'] = 'there is no meet and greet in the service area'
            this.noInsertList.push(route)
            continue
          }

          let resCosts = await getCostProfit(url, routeId)
          let costs = resCosts.results || []

          for (let c of costs) {
            // let { vehicle_class_id } = c
            // let vehiclePercent = vcs.find(item => item.id == vehicle_class_id)
            // let pm = vehiclePercent?.percent || partnerMarkup
            // c['partner_markup'] = `${pm / 100}`
            // c['sla'] = '0'
            c['mng'] = `${mng}`
          }

          console.log(costs);
          let insertCostRes = await insertCost(url, costs)
        }
      },

      async getAddrList(keywords = 'SFO') {
        if (!keywords) {
          return []
        }
        let list = cache[keywords]
        if (list) {
          return list
        }

        let { boundLat, boundLng, sessionToken, boundRadius } = this.originLatLng

        let url = `https://388bivap71.execute-api.us-east-2.amazonaws.com/prod/maps/places/auto-comp`
        let d = {
          input_text: keywords,
          location: `${boundLat},${boundLng}`,
          radius: boundRadius
        }
        if (sessionToken) {
          d['session_token'] = sessionToken
        }
        let res = await fetchData({
          url,
          data: d,
          isShowLoading: false
        })
        if (!res) return
        let { session_token } = res
        this.originLatLng.sessionToken = session_token
        list = res.predictions.predictions

        cache[keywords] = list
        return list
      },
      async getDetailByPlaceId(id) {

        let obj = cache[id]
        if (!obj) {
          let url = `https://388bivap71.execute-api.us-east-2.amazonaws.com/prod/maps/places/id`
          let d = {
            google_place_id: id
          }

          let { place_detail } = await fetchData({ url, data: d, isShowLoading: false })
          let { status } = place_detail

          if (status == 'OK') {
            let { result: { formatted_address, name: localName, geometry: { location } } } = place_detail

            let val = `${localName} ${formatted_address}`
            if (formatted_address.startsWith(localName)) {
              val = formatted_address
            }
            // this.elm.value = val

            let { lat, lng, } = location
            let t = typeof lat === 'number' ? lat : lat()
            let g = typeof lng === 'number' ? lng : lng()

            this.originLatLng.boundLat = lat
            this.originLatLng.boundLng = lng

            obj = { lat: t, lng: g, name: val }
          }
        }
        return obj
      },

      async getPriceElife(fLat, fLng, tLat, tLng, demand_fleet_id, supply_fleet_id) {
        let url = `https://j1j495o5pk.execute-api.us-east-2.amazonaws.com/upncoming/ride-pricings?from_lat=${fLat}&from_lng=${fLng}&to_lat=${tLat}&to_lng=${tLng}&ses=Unrfxa1M0lDAR4ODnRXP5DKfaLTD0Oe6SOfN6FtkCTTIdGi0jB8rcoLk8fsiJSDVd3V9o6hOkzZLeJxp46fW1VpAp7FznwOcR8e6LiMoBBQne4g9PyHdP9pe34omovzH&currency=USD&demand_fleet_id=${demand_fleet_id}&supply_fleet_id=${supply_fleet_id}`
        let response = await fetch(url)
        let res = await response.json();
        let { fleets } = res
        if (!fleets.length) {
          return []
        }
        let list = fleets[0].vehicle_classes
        return list
      },

      async getCost(ids, version) {
        let d = {
          sql: 134679330,
          version: version,
        }
        if (ids) {
          d['route_id'] = ids
        }

        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })


        return res
      },

      async runSQL(params) {
        let d = {
          sql: 134679330
        }

        d = Object.assign(d, params)

        let res = await fetchData({
          url,
          method: 'POST',
          data: d
        })

        return res

      }
    },

    setup() {
      const inputValueRouteIds = ref('');
      const form = ref({
        ids: '',
        partnerId: '',
      })

      const activeName = ref('checkRoutes')

      const partnerIds = ref([
        {
          id: 2
        }
      ])

      const originLatLng = ref({ //initial bound lat and lng is sfo's
        boundLat: 37.6213129,
        boundLng: -122.3789554,
        boundRadius: 200000
      })

      return {
        abc: 1,
        noInsertList: [],
        existsIds: [],
        doneList: [],
        newRouteIds: [],
        form,
        activeName,
        partnerIds,
        originLatLng

      }
    },




  });





  app.use(ElementPlus);

  app.mount("#app");
</script>
</html>