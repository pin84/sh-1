set @04_01_2024_utc := 1711918800;
select distinct au.id as a_id
,au.currency
,au.amount
,au.price_version
,au.active
,au.start_time_str
,ride.id as r_id
,vehicle_class.name as v_c_name
,ar.trip_no
,ride.vip
,ride.meet_n_greet
,ride.driver_instruction
,au.next_amount_update
,au.amount_update_interval
,au.ceilling
,au.increment
,ride.trip_count
,f_address.lat
,f_address.lng
,if(trip.start_time_utc is null, ride.from_utc, trip.start_time_utc) as ride_from_utc
,if(trip.start_time_str is null, if(ar.trip_no=1, ride.to_time_str, ride.from_time_str), trip.start_time_str) as ride_from_time_str
,if(
ride.from_flight_str is not null or ride.to_flight_str is not null or ride.from_flight_sch is not null or ride.to_flight_sch is not null or
ride.from_flight_str <> '' or ride.to_flight_str <> '' or ride.from_flight_sch <> '' or ride.to_flight_sch <> ''
or (select count(*) from trip t WHERE t.trip_no=ar.trip_no and t.ride_id=ride.id 
and (
t.start_flight_str is not null or t.end_flight_str is not null or t.start_flight_sch is not null or t.end_flight_sch is not null or
t.start_flight_str <> '' or t.end_flight_str <> '' or t.start_flight_sch <> '' or t.end_flight_sch <> '') <> 0
), 'Yes', 'No'
) as has_flight
, @commission:=if((dispatch.trip_no >= 0 or dispatch.from_utc < @04_01_2024_utc or sda.demand_fleet_id is null) and p_t.partner_id not in (36,33,2661), 0,
if(p_t.partner_id in (36,33,2661), if(p_t.partner_id = 36, 20, if(p_t.partner_id = 33, 15, if(p_t.partner_id = 2661, 19.81, 0))),abs(cast(json_extract(sda.json, '$.percent') as decimal(10, 2))))) as comm
, @commission_p:=@commission / 100 as comm_p
, if((dispatch.trip_no >= 0 or dispatch.from_utc < @04_01_2024_utc or sda.demand_fleet_id is null) and p_t.partner_id not in (36,33,2661),
dispatch.amount,
if(ap.partner & 2,dispatch.amount - (dispatch.amount * @commission_p),'*')) as elife_amount
,dispatch.amount as partner_amount
,dispatch.currency as elife_currency
,rs.score_response
,partner.id as partner_id
,auction_fleet.fleet_id
,af_info.name as fleet_name
from auction_ride ar
inner join auction au on ar.auction_id=au.id
inner join ride on ar.ride_id=ride.id join login ON login.id = {{ login_id }}
inner join partner_tran p_t on p_t.id = ride.partner_tran_id
inner join partner on partner.id = p_t.partner_id
inner join dispatch on ride.id=dispatch.ride_id
inner join fleet on ride.service_area_id=fleet.id
inner join vehicle_class on vehicle_class.id=ride.vehicle_class_id
inner join place f_place on ride.from_place_id=f_place.id
inner join address f_address on f_place.address_id=f_address.id
left join airport_fleet on ride.service_area_id=airport_fleet.fleet_id and airport_fleet.parent_fleet_id={{access_fleet_id}}
left join airport on airport_fleet.airport=airport.code3
left join trip on trip.ride_id=ar.ride_id and trip.trip_no = ar.trip_no
left join access_pass ap on ap.id = login.access_pass_id
left join ride_score rs on ride.id = rs.ride_id
left join supply_demand_adjustment sda on sda.demand_fleet_id = dispatch.from_fleet_id and dispatch.trip_no = -1
left join auction_fleet on ar.auction_id = auction_fleet.auction_id
left join fleet af_info on auction_fleet.fleet_id = af_info.id
where {{access_fleet_id}}={{elife_fleet_id}}
and au.fleet_id is null
and dispatch.trip_no_x=-1
and (
(trip.start_time_utc is not null and trip.start_time_utc > unix_timestamp(now())) 
or (ar.trip_no=1 and ride.to_utc > unix_timestamp(now())) 
or (ar.trip_no=0 and ride.from_utc > unix_timestamp(now()))
)
and ride.stat not in(134610949,134610950)
and ride.from_utc is not null
and ride.from_time_str is not null
and (
(select count(*) from dispatch where dispatch.ride_id=ride.id and dispatch.trip_no_x is not null )=1
or (select count(*) from dispatch where dispatch.ride_id=ride.id and dispatch.trip_no_x is not null and ride.trip_count=2)=2
)
and (
(
(select count(*) from access_airport where access_id={{access_id}})=0
and (select count(*) from access_country where access_id={{access_id}})=0
)
or (
(
(select count(*) from access_airport where access_id={{access_id}})>0
and (select count(*) from access_country where access_id={{access_id}})=0
)
and ride.service_area_id in(select airport_fleet.fleet_id from access_airport,airport_fleet where access_id={{access_id}}
and access_airport.airport = airport_fleet.airport and airport_fleet.parent_fleet_id={{access_fleet_id}})
)
or (
(
(select count(*) from access_airport where access_id={{access_id}})= 0
and (select count(*) from access_country where access_id={{access_id }})>0
)
and airport.ctry in(select airport_country from access_country where access_id={{access_id}})
)
or (
(
(select count(*) from access_airport where access_id={{access_id}})>0
and (select count(*) from access_country where access_id={{access_id}})>0
)
and (
ride.service_area_id in(select airport_fleet.fleet_id from access_airport,airport_fleet where access_id={{access_id}}
and access_airport.airport=airport_fleet.airport and airport_fleet.parent_fleet_id={{access_fleet_id}}
)
or airport.ctry in(select airport_country from access_country where access_id={{access_id}})
)
)
)
{%if ride_id or auction_id%}
{%if auction_id%}
and au.id={{auction_id}}
{%endif%}
{%if ride_id %}
and ride.id={{ride_id}}
{%endif%}
{%else%}
{%if service_area_id%}
and ride.service_area_id={{service_area_id}}
{%endif%}
{%if auction_active%}
and au.active={{auction_active}}
{%endif%}
{%if ride_time%}
and (ride.from_time_str='{{ride_time}}' or ride.to_time_str='{{ride_time}}')
{% endif %}
{%if vehicle_classes%}
and ride.vehicle_class_id in({%for vc in vehicle_classes%}{%if loop.index0>0%},{%endif%}{{vc}}{%endfor%})
{%endif%}
{%endif%}
{%if partner_id%}
and partner.id={{partner_id}}
{%endif%}
{%if drive_ins_yes%}
and (ride.driver_instruction is not null and ride.driver_instruction <> '' or (select count(*) from trip t WHERE t.trip_no=ar.trip_no and t.ride_id=ride.id and t.driver_instruction is not null and t.driver_instruction <> '')<>0)
{%endif%}
{%if drive_ins_no%}
and (ride.driver_instruction is null or ride.driver_instruction = '' and (select count(*) from trip t WHERE t.trip_no=ar.trip_no and t.ride_id=ride.id and (t.driver_instruction is null or t.driver_instruction = ''))<>0)
{%endif%}
{%if vip_only%}
and (ride.vip={{vip_only}} or ({{vip_only}}<>1 and ride.vip is null))
{%endif%}
{%if meet_and_greet%}
and (ride.meet_n_greet={{meet_and_greet}} or ({{meet_and_greet}}<>1 and ride.meet_n_greet is null))
{%endif%}
{%if has_flight_yes%}
and (ride.from_flight_str is not null or ride.to_flight_str is not null or ride.from_flight_sch is not null or ride.to_flight_sch is not null or
ride.from_flight_str <> '' or ride.to_flight_str <> '' or ride.from_flight_sch <> '' or ride.to_flight_sch <> ''
or (select count(*) from trip t WHERE t.trip_no=ar.trip_no and t.ride_id=ride.id 
and (
t.start_flight_str is not null or t.end_flight_str is not null or t.start_flight_sch is not null or t.end_flight_sch is not null or
t.start_flight_str <> '' or t.end_flight_str <> '' or t.start_flight_sch <> '' or t.end_flight_sch <> ''
)<>0)
)
{%endif%}
{%if has_flight_no%}
and (
(ride.from_flight_str is null and ride.to_flight_str is null and ride.from_flight_sch is null and ride.to_flight_sch is null) or
(ride.from_flight_str = '' and ride.to_flight_str = '' and ride.from_flight_sch = '' and ride.to_flight_sch = '')
and (select count(*) from trip t WHERE t.trip_no=ar.trip_no and t.ride_id=ride.id 
and (
(t.start_flight_str is null and t.end_flight_str is null and t.start_flight_sch is null and t.end_flight_sch is null) or
(t.start_flight_str = '' and t.end_flight_str = '' and t.start_flight_sch = '' and t.end_flight_sch = '')
)=0)
)
{%endif%}
{%if private_auction%}
and 
( 
(au.currency is null and au.amount is null and auction_fleet.amount is not null and auction_fleet.currency is not null)
or auction_fleet.id is not null
)
{%endif%}
{%if public_auction%}
and au.currency is not null 
and au.amount is not null
and auction_fleet.id is null
{%endif%}
group by au.id
{% if orderBy and orderDir %}
order by {{ orderBy }} {{ orderDir }}, ride_from_time_str asc
{% endif %}
{% if start and rows_to_fetch %}
limit {{start}}, {{ rows_to_fetch }}
{% endif %};
