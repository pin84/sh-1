<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>


    <script>

        let data = []




        console.log('-----');

        // 判断两条线段是否相交
        function isIntersect(p1, q1, p2, q2) {
            // 辅助函数：计算向量 (p, q) 和 (r, s) 的叉积
            function crossProduct(p, q, r) {
                return (q.lat - p.lat) * (r.lng - p.lng) - (q.lng - p.lng) * (r.lat - p.lat);
            }

            // 检查 (p1, q1) 和 (p2, q2) 是否相交
            const d1 = crossProduct(p2, q2, p1);
            const d2 = crossProduct(p2, q2, q1);
            const d3 = crossProduct(p1, q1, p2);
            const d4 = crossProduct(p1, q1, q2);

            // 检查是否跨越
            if ((d1 * d2 < 0) && (d3 * d4 < 0)) {
                return true;
            }

            // 检查是否共线重叠
            function isOnSegment(p, q, r) {
                return Math.min(p.lat, q.lat) <= r.lat && r.lat <= Math.max(p.lat, q.lat) &&
                    Math.min(p.lng, q.lng) <= r.lng && r.lng <= Math.max(p.lng, q.lng);
            }

            if (d1 === 0 && isOnSegment(p2, q2, p1)) return true;
            if (d2 === 0 && isOnSegment(p2, q2, q1)) return true;
            if (d3 === 0 && isOnSegment(p1, q1, p2)) return true;
            if (d4 === 0 && isOnSegment(p1, q1, q2)) return true;

            return false;
        }

        // 判断多边形是否有相交的边
        function hasSelfIntersect(polygon) {
            const n = polygon.length;
            for (let i = 0; i < n; i++) {
                const p1 = polygon[i];
                const q1 = polygon[(i + 1) % n];
                for (let j = i + 1; j < n; j++) {
                    const p2 = polygon[j];
                    const q2 = polygon[(j + 1) % n];
                    // 忽略相邻边的相交
                    if (Math.abs(i - j) === 1 || (i === 0 && j === n - 1) || (i === n - 1 && j === 0)) {
                        continue;
                    }
                    if (isIntersect(p1, q1, p2, q2)) {
                        return true;
                    }
                }
            }
            return false;
        }

        function checker() {
            let ids = []
            for (let item of data) {
                let { from_place_lat_lng, to_place_lat_lng, id } = item
                let from = JSON.parse(from_place_lat_lng)
                let to = JSON.parse(to_place_lat_lng)
                let fPolygons = from.polygons || undefined
                let tPolygons = to.polygons || undefined
                if (fPolygons) {
                    let flag = hasSelfIntersect(fPolygons)
                    if (flag) {
                        ids.push(id)
                    }
                }
                if (tPolygons) {
                    let flag = hasSelfIntersect(tPolygons)
                    if (flag) {
                        ids.push(id)
                    }
                }
            }
            console.log(ids);
        }

        checker()
        // console.log(hasSelfIntersect(dataHandler(polygon))); // 输出: true

    </script>
</body>

</html>